<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Away0x's Blog]]></title>
  <link href="http://away0x.github.io/atom.xml" rel="self"/>
  <link href="http://away0x.github.io/"/>
  <updated>2021-04-26T10:42:16+08:00</updated>
  <id>http://away0x.github.io/</id>
  <author>
    <name><![CDATA[TongWu]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - Protocol]]></title>
    <link href="http://away0x.github.io/blog/2018/02/07/oc-protocol/"/>
    <updated>2018-02-07T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/07/oc-protocol</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#o1">基础</a></li>
<li><a href="#o2">使用场景</a></li>
</ul>


<h1><h2 id="o1">基础</h2></h1>

<ul>
<li>Java 中有 interface 接口。而 OC 中 interface 是类的头文件声明，OC 的接口由 protocol 实现</li>
<li>protocol 可<strong>声明一些必须实现的方法和选择实现的方法</strong></li>
<li>protocol 的作用

<ol>
<li>用来声明一些方法</li>
</ol>
</li>
<li>protocol 是由一系列的方法声明组成的</li>
<li><strong>类遵守 protocol</strong>

<ol>
<li>一个类可以遵守一个或多个 protocol</li>
<li>任何类只要遵守了 protocol，就相当于拥有了 protocol 的所有方法声明</li>
</ol>
</li>
<li><strong>协议和继承的区别</strong>

<ol>
<li>继承后默认就有实现，而协议只有声明没有实现</li>
<li>相同类型的类可以使用继承，但是不同类型的类只能使用协议</li>
<li>协议可用于存储方法的声明，可以将多个类中共同的方法抽取出来，以后让这些类遵守协议即可</li>
</ol>
</li>
<li><strong>协议的注意事项</strong>

<ol>
<li>协议只能声明方法，不能声明属性</li>
<li>父类遵守了某个协议，那么子类也会自动遵守这个协议</li>
<li>OC 中一个类可以遵守一个或多个协议</li>
<li>OC 中的协议可遵守其他协议，只要一个协议遵守了其他协议，那么这个协议中就会自动包含其他协议的声明</li>
</ol>
</li>
</ul>


<h2>定义</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 定义 protocol</span>
</span><span class='line'><span class="k">@protocol</span> <span class="err">协议名称</span>
</span><span class='line'><span class="c1">// 方法声明列表</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 类遵守 protocol</span>
</span><span class='line'><span class="k">@interface</span> <span class="err">类名 : 父类 &lt;协议1, 协议2, ...&gt;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>基协议 NSObject</h2>

<ul>
<li>NSObject 是一个基类，最根本最基本的类，任何其他类都要继承自它</li>
<li>还有个协议也叫 NSObject，它是一个基协议，最根本最基本的协议</li>
<li>NSObject 协议中声明了很多最基本的方法

<ol>
<li>description</li>
<li>retain</li>
<li>release</li>
</ol>
</li>
<li>建议每个新的协议都要遵守 NSObject 基协议</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@protocol</span> <span class="nc">DemoProtocol</span> <span class="o">&lt;</span><span class="bp">NSObject</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>@required &amp; @optional</h2>

<ul>
<li>@require: (默认) 这个方法必须实现，不实现会有警告，但不会报错</li>
<li>@optional: 这个方法不一定要实现</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@protocol</span> <span class="nc">DemoProtocol</span> <span class="o">&lt;</span><span class="bp">NSObject</span><span class="o">&gt;</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> func0、func1、func2 不实现会有警告</span>
</span><span class='line'><span class="cm"> func3 可以不实现</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">func0</span><span class="p">;</span> <span class="c1">// 默认是 required</span>
</span><span class='line'>
</span><span class='line'><span class="k">@required</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">func1</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">func2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@optional</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">func3</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o2">使用场景</h2></h1>

<h2>类型限制</h2>

<ul>
<li>通过协议来限制类型</li>
<li><code>数据类型&lt;协议名称&gt; 变量名</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@protocol</span> <span class="nc">Animal</span> <span class="o">&lt;</span><span class="bp">NSObject</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">eat</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">run</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 如果 dog 没有遵守 Animal 协议就会报警告</span>
</span><span class='line'><span class="n">Dog</span><span class="o">&lt;</span><span class="n">Animal</span><span class="o">&gt;</span> <span class="n">dog</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Dog</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="nc">Dog</span> : <span class="bp">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 限制 property 的类型需要遵守 Animal 协议</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">Puppy</span><span class="o">&lt;</span><span class="n">Animal</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">puppy1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 这个 property 无论是何类都可，但是得遵守 Animal 协议</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="kt">id</span><span class="o">&lt;</span><span class="n">Animal</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">son</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意:</strong> 虽然在对对象进行了类型限定(限定它必须实现某个协议)，但并不意味着这个对象就真正的实现了该方法(不实现只是由警告无报错)。所以在调用对象的协议方法时，应该进行判断</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Dog</span><span class="o">&lt;</span><span class="n">Animal</span><span class="o">&gt;</span> <span class="n">dog</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Dog</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 判断 dog 是否能响应 eat 消息 (即是否有实现这个方法)</span>
</span><span class='line'><span class="k">if</span> <span class="p">([</span><span class="n">dog</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">eat</span><span class="p">)])</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">dog</span> <span class="n">eat</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>委托代理</h2>

<p>详见类之间通信的笔记</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - Constructor]]></title>
    <link href="http://away0x.github.io/blog/2018/02/06/oc-constructor/"/>
    <updated>2018-02-06T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/06/oc-constructor</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#o1">new &amp; init</a></li>
<li><a href="#o2">instancetype &amp; id</a></li>
<li><a href="#o3">自定义构造方法</a></li>
<li><a href="#o4">自定义类工厂方法</a></li>
<li><a href="#o5">类的本质</a></li>
</ul>


<blockquote><p>OC 中的构造方法实际上并不是传统意义上的构造方法</p></blockquote>

<h1><h2 id="o1">new &amp; init</h2></h1>

<h2>new</h2>

<ul>
<li>new 做了三件事情

<ol>
<li>开辟存储空间</li>
<li>初始化所有的属性(实例变量)</li>
<li>返回对象的地址</li>
</ol>
</li>
<li>new 相当于是 alloc 和 init 的组合</li>
<li><strong>推荐使用 alloc + init 的方式</strong>

<ol>
<li>能够统一编码格式能够统一的对代码进行初始化 (使用 new 不方便使用自定义构造方法)</li>
</ol>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 相当于下面</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">alloc 做的事</span>
</span><span class='line'><span class="cm">    1. 开辟存储空间 </span>
</span><span class='line'><span class="cm">    2. 将所有的属性设置为 0 (无论属性是何类型)</span>
</span><span class='line'><span class="cm">    3. 返回当前实例对象的地址</span>
</span><span class='line'><span class="cm">init 做的事</span>
</span><span class='line'><span class="cm">    1. 初始化成员变量，但是默认情况下 init 的实现是什么都没有做</span>
</span><span class='line'><span class="cm">    2. 返回初始化后的实例变量</span>
</span><span class='line'><span class="cm">    </span>
</span><span class='line'><span class="cm">注意: alloc 返回的地址，和 init 返回的地址是同一个地址</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">];</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%p %p&quot;</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span> <span class="c1">// 相同</span>
</span></code></pre></td></tr></table></div></figure>


<h2>init</h2>

<ul>
<li>OC 中以 init 开头的方法，称之为构造方法</li>
<li>用途: 用于初始化一个对象，让某个对象一创建出来就拥有某些属性和值</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@implementation</span> <span class="nc">Person</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 重写 init 方法，在 init 方法中初始化实例变量</span>
</span><span class='line'><span class="c1">// 注意: 重写 init 方法必须按苹果规定的格式重写，不这样会引发一些未知的错误</span>
</span><span class='line'><span class="c1">//    1. 先初始化父类，再初始化子类</span>
</span><span class='line'><span class="c1">//    2. 判断父类是否初始化成功，只有父类初始化成功才能继续初始化子类</span>
</span><span class='line'><span class="c1">//    3. 返回当前对象的地址</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1. 初始化父类</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span> <span class="c1">// 初始化成功返回对应地址，失败返回 nil</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2. 判断是否初始化成功</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2.1 初始化子类 (如设置实例变量的值)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 3. 返回地址</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o2">instancetype &amp; id</h2></h1>

<ul>
<li>instancetype 和 id 一样都是万能指针</li>
<li>如果构造函数返回值是 instancetype，那么将返回值赋值给一个其他的对象会报一个警告；id 类型则不会</li>
<li>instancetype 在编译时可判断对象的真实类型，id 则不能</li>
<li>id 可用来定义变量，可以作为返回值，可以作为形参。instancetype 只能作为返回值</li>
<li><strong>注意:</strong> 定义构造方法，返回值尽量使用 instancetype，不要使用 id</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@implementation</span> <span class="nc">Person</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 报警告！将 instancetype 赋给其他对象了</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@implementation</span> <span class="nc">Person</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="c1">// 不会报警告，因为返回值是 id 类型 (新版本 xcode 也会警告了)</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o3">自定义构造方法</h2></h1>

<ul>
<li>一个类可以有 0 个或者多个自定义构造方法</li>
<li>其实就是自定义一个 init 方法

<ol>
<li>一定是实例方法</li>
<li>一定返回 id/instancetype (建议 instancetype)</li>
<li>方法名一定以 init 开头，之后有参数的 <code>initWithXXX</code>，W 一定要大写 (苹果硬性规定)

<ul>
<li>initwithxxx W 小写的话，不认为其是自定义构造方法，其内不能调用 <code>[super init]</code></li>
</ul>
</li>
</ol>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// Person.h</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">Person</span> : <span class="bp">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Person.m</span>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">Person</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_age</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 自定义构造方法</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithAge:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">age</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithAge</span><span class="p">:</span><span class="mi">25</span><span class="p">];</span>
</span><span class='line'><span class="n">p</span><span class="p">.</span><span class="n">age</span><span class="p">;</span> <span class="c1">// 25</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o4">自定义类工厂方法</h2></h1>

<ul>
<li>类工厂方法是一种用于分配、初始化实例并返回一个它自己的实例的类方法</li>
<li>类工厂方法规范

<ol>
<li>一定是类方法</li>
<li>返回值一般是 instancetype 类型</li>
<li>方面名以类名开头，首字母小写</li>
<li>类工厂中创建对象不要使用类名创建，应该使用 self 来创建</li>
</ol>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">personWithAge:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">age</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 不能是 [Person alloc]，否则继承时会有问题</span>
</span><span class='line'>    <span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">p</span> <span class="nl">setAge</span><span class="p">:</span><span class="n">age</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="nl">personWithAge</span><span class="p">:</span><span class="mi">25</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o5">类的本质</h2></h1>

<ul>
<li>类的本质其实也是一个对象 (类对象)</li>
<li>程序中第一次使用该类的时候被创建，在整个程序中只有一份</li>
<li>此后每次使用都是这个类对象，它在程序运行时一直存在</li>
<li>类对象是一种数据结构，存储类的基本信息: 类大小、类名称、类的版本、继承层次、以及消息与函数的映射表等</li>
<li>类对象代表类，Class 类型，对象方法属于类对象</li>
<li>如果消息的接收者是类名，则类名代表类对象</li>
<li>所有类的实例都由类对象生成，类对象会把实例的 isa 的值修改成自己的地址，每个实例的 isa 都指向该实例的类对象</li>
</ul>


<h2>获取类对象</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 1. 通过实例对象</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="kt">Class</span> <span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">class</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 通过类名获取 (类名其实就是类对象)</span>
</span><span class='line'><span class="kt">Class</span> <span class="n">c2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="k">class</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 应用场景</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 1. 用于创建实例对象</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">c1</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2. 用于调用类方法</span>
</span><span class='line'><span class="p">[</span><span class="n">c1</span> <span class="n">test</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h2>类的启动过程</h2>

<p>只要程序启动就会将类的代码加载到内存中，放到代码区</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="p">@</span><span class="n">inplementation</span> <span class="n">Person</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// load 方法会在当前类被加载到内存时调用，仅会被调用一次</span>
</span><span class='line'><span class="c1">// 如存在继承关系，会先调用父类的 load 方法，再调用子类的 load 方法</span>
</span><span class='line'><span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">load</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;类被加载到内存中了...&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 当前类第一次被使用时会调用 (创建类对象的时候)</span>
</span><span class='line'><span class="c1">// 在整个程序的运行过程中只会被调用一次，无论你使用多少次这个类都只会调用一次</span>
</span><span class='line'><span class="c1">// 用于对某一个类进行一次性的初始化</span>
</span><span class='line'><span class="c1">// 如存在继承关系，会先调用父类的 initialize 方法，再调用子类的 initialize 方法</span>
</span><span class='line'><span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">initialize</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;类第一次被使用啦&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - 面向对象基础(二)]]></title>
    <link href="http://away0x.github.io/blog/2018/02/05/oc-oop-features/"/>
    <updated>2018-02-05T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/05/oc-oop-features</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#o1">封装</a></li>
<li><a href="#o2">继承</a></li>
<li><a href="#o3">多态</a></li>
</ul>


<h1><h2 id="o1">封装</h2></h1>

<ul>
<li>屏蔽内部实现的细节，仅对外提供公有的方法/接口</li>
<li>优点: 保证数据的安全性，将变化隔离</li>
</ul>


<h2>实例变量的封装</h2>

<h3>未封装的实例变量</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="nc">Demo</span> : <span class="bp">NSObject</span> <span class="p">{</span>
</span><span class='line'><span class="k">@public</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">_age</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="p">@</span><span class="n">impletation</span> <span class="n">Demo</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Demo</span> <span class="o">*</span><span class="n">demo</span> <span class="o">=</span> <span class="p">[</span><span class="n">Demo</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="n">demo</span><span class="o">-&gt;</span><span class="n">_age</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">demo</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用 getter/setter 封装实例变量</h3>

<ul>
<li>二者写法格式是固定的</li>
<li><strong>setter</strong>

<ol>
<li>作用: 设置实例变量的值</li>
<li>一定是实例方法且无返回值</li>
<li>一定有参数，参数类型和需设置的实例变量类型相同，且名称是实例变量的名称去掉下划线</li>
<li>命名一定是 &ldquo;set + 实例变量&rdquo; (实例变量名去掉开头下划线，且首字母大写)</li>
</ol>
</li>
<li><strong>getter</strong>

<ol>
<li>获取实例变量的值</li>
<li>一定是实例方法且有返回值</li>
<li>返回值和获取的实例变量的类型一致</li>
<li>一定无参数</li>
<li>命名是获取的实例变量的名称去掉下划线</li>
</ol>
</li>
<li>只读属性: 私有实例变量只提供了 getter</li>
<li>只写属性: 私有实例变量只提供了 setter</li>
<li>可读可写属性: 私有实例变量只提供了 getter、setter</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="nc">Demo</span> : <span class="bp">NSObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">_age</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// setter 声明</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setAge:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">age</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// getter 声明</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">age</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="p">@</span><span class="n">impletation</span> <span class="n">Demo</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// setter 实现</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">setAge</span><span class="p">:(</span><span class="kt">int</span><span class="p">)</span><span class="n">age</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// getter 实现</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">age</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_age</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Demo</span> <span class="o">*</span><span class="n">demo</span> <span class="o">=</span> <span class="p">[</span><span class="n">Demo</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">demo</span> <span class="nl">setAge</span><span class="p">:</span><span class="mi">25</span><span class="p">];</span>     <span class="c1">// setter</span>
</span><span class='line'><span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="p">[</span><span class="n">demo</span> <span class="n">age</span><span class="p">];</span> <span class="c1">// getter</span>
</span></code></pre></td></tr></table></div></figure>


<h2>点语法</h2>

<ul>
<li>如果实例属性提供了 setter、getter 方法，那么访问属性又多了一种访问方式: <strong>点语法</strong></li>
<li>点语法的本质是调用了 setter/getter (C++ 中的点可以直接访问实例变量)</li>
<li>点语法是一个编译器特性，实际并不是 OC 的语法

<ul>
<li>会在程序翻译成二进制时，将点语法自动转换为 setter/getter</li>
</ul>
</li>
<li>点语法的注意点:

<ul>
<li>点语法一般用于给实例变量赋值，如果不是给实例变量赋值一般情况不建议使用</li>
<li>因为其是编译器特性，会将 <code>a.b</code> 翻译成 <code>[a b]</code> 所以也可以调用一些实例方法，但不要使用</li>
<li><code>请将点语法当成是便捷版的实例变量 getter/setter 的使用方式，其他情况下请不要使用</code></li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Demo</span> <span class="o">*</span><span class="n">demo</span> <span class="o">=</span> <span class="p">[</span><span class="n">Demo</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="n">demo</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span> <span class="c1">// 相当于 setter &quot;[demo setAge:25];&quot;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">demo</span><span class="p">.</span><span class="n">age</span><span class="p">;</span> <span class="c1">// 相当于 getter &quot;int age = [demo age];&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o2">继承</h2></h1>

<ul>
<li>OC 是单继承</li>
<li>A 类继承了 B 类，那么 B 类就拥有了 A 类所有属性和方法</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// Demo 继承了 NSObject</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">Demo</span> : <span class="bp">NSObject</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="p">@</span><span class="n">impletation</span> <span class="n">Demo</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>如子类中有和父类同名的方法，称之为 <strong>方法重写</strong></li>
<li>继承中的方法调用顺序: 自己有就调用自己的，自己无就调用父类的，以此类推，逐级往上

<ul>
<li>如一直找到 NSObject 类都没有找到，那么就会报错</li>
</ul>
</li>
<li>继承的优点:

<ol>
<li>提高了代码的复用性</li>
<li>让类与类之间产生了关系，这才有了多态</li>
</ol>
</li>
</ul>


<h2>super</h2>

<ul>
<li>super 和 self 指向的是相同的消息接收者</li>
<li>作用:

<ol>
<li>直接调用父类中的某个方法</li>
<li>super 在实例方法中，会调用父类的实例方法</li>
<li>super 在类方法中，会调用父类的类方法</li>
</ol>
</li>
<li>使用场景:

<ol>
<li>子类重写父类的方法时，想保留父类的一些行为</li>
</ol>
</li>
</ul>


<h1><h2 id="o3">多态</h2></h1>

<ul>
<li>多态: 事物的多种表现形态</li>
<li>OC 不同于传统程序设计语言，它可以在运行时加入新的数据类型和新的程序模块: 动态类型识别、动态绑定、动态加载</li>
<li>多态的条件:

<ol>
<li>有继承关系</li>
<li>子类重写父类方法</li>
<li>父类指针指向子类对象</li>
</ol>
</li>
<li>表现: 当父类指针指向不同对象的时候，通过父类指针调用被重写的方法时，会执行指正所指向</li>
<li>优点:

<ol>
<li>提高了代码的拓展性</li>
</ol>
</li>
<li>注意点:

<ol>
<li>如父类指针指向子类对象，如需调用<strong>子类特有</strong>的方法，必须先强制类型转换为子类才能调用</li>
</ol>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 实现多态</span>
</span><span class='line'><span class="c1">// Animal 是父类，子类有 Cat 和 Dog，分别重写了父类的 eat 方法</span>
</span><span class='line'><span class="c1">// 那么实例化时，可这样:</span>
</span><span class='line'><span class="n">Animal</span> <span class="o">*</span><span class="n">animal</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 实例化 Dog</span>
</span><span class='line'><span class="n">animal</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dog</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">animal</span> <span class="n">eat</span><span class="p">];</span> <span class="c1">// Dog 的 eat</span>
</span><span class='line'><span class="c1">// 实例化 Cat</span>
</span><span class='line'><span class="n">animal</span> <span class="o">=</span> <span class="p">[</span><span class="n">Cat</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">animal</span> <span class="n">eat</span><span class="p">];</span> <span class="c1">// Cat 的 eat</span>
</span></code></pre></td></tr></table></div></figure>


<h2>动态类型</h2>

<ul>
<li>在编译时编译器只会检查当前类型中有没有需要调用的方法</li>
<li>运行时，才会去判断对象的真实类型</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Animal</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dog</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="c1">// 首先由于 a 是 Animal 类型，所以编译时会在去 Animal 里找是否已 eat 方法，无, 会编译失败</span>
</span><span class='line'><span class="c1">// 然后在运行时，系统判断出了 a 的真实类型是 Dog 类型</span>
</span><span class='line'><span class="c1">// 因此这里调用的是 Dog 类的 eat 方法，而不是 Animal 类</span>
</span><span class='line'><span class="p">[</span><span class="n">a</span> <span class="n">eat</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="c1">// 如果想调用子类特有的方法，必须强制类型转换为子类才能调用</span>
</span><span class='line'><span class="c1">// 如子类 Dog 特有方法 dogEat，Animal 类没有这个方法</span>
</span><span class='line'><span class="p">[</span><span class="n">a</span> <span class="n">dogEat</span><span class="p">];</span> <span class="c1">// 报错，因为编译阶段发现 Animal 中没有这个方法</span>
</span><span class='line'>
</span><span class='line'><span class="n">Dog</span> <span class="o">*</span><span class="n">dog</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dog</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="n">dog</span> <span class="n">dogEat</span><span class="p">];</span> <span class="c1">// 正确</span>
</span></code></pre></td></tr></table></div></figure>


<h2>id 类型</h2>

<p>id 类型: 通用对象指针类型，弱类型，编译时不进行类型检查</p>

<h2>应用场景</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="nc">Person</span>: <span class="bp">NSObject</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">food:</span><span class="p">(</span><span class="n">Animal</span> <span class="o">*</span><span class="p">)</span><span class="nv">animal</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">Person</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">food:</span><span class="p">(</span><span class="n">Animal</span> <span class="o">*</span><span class="p">)</span><span class="nv">animal</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 运行时会动态监测 animal 的真实类型，从而调用对应类型的方法</span>
</span><span class='line'>    <span class="c1">// 这样就不用创建针对于不同类型的 food 方法啦</span>
</span><span class='line'>    <span class="c1">// 如果真实类型没有 eat 方法，这会找到 Animal 类，调用其的 eat 方法</span>
</span><span class='line'>    <span class="c1">// 注意这里 Animal 类得有 eat 方法，因为编译时会做检测</span>
</span><span class='line'>    <span class="c1">// 运行时才会确定真实类型</span>
</span><span class='line'>    <span class="p">[</span><span class="n">animal</span> <span class="n">eat</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="c1">// Cat Dog 继承与 Animal</span>
</span><span class='line'><span class="c1">// Animal 有 eat 方法</span>
</span><span class='line'><span class="c1">// Cat Dog 都各自重写了父类的 eat 方法</span>
</span><span class='line'><span class="n">Dog</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dog</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="n">Cat</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">Cat</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">Person</span> <span class="nl">food</span><span class="p">:</span><span class="n">d</span><span class="p">];</span> <span class="c1">// 调用的是 Dog 的 eat 方法</span>
</span><span class='line'><span class="p">[</span><span class="n">Person</span> <span class="nl">food</span><span class="p">:</span><span class="n">c</span><span class="p">];</span> <span class="c1">// 调用的是 Cat 的 eat 方法</span>
</span></code></pre></td></tr></table></div></figure>


<h2>注意点</h2>

<p>如果存在多态，父类是可以访问子类特有的方法。否则不能直接调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 子类特有方法 bark</span>
</span><span class='line'><span class="p">[</span><span class="n">dog</span> <span class="n">bark</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">Animal</span> <span class="o">*</span><span class="n">animal</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dog</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="p">[(</span><span class="n">Dog</span> <span class="o">*</span><span class="p">)</span><span class="n">animal</span> <span class="n">bark</span><span class="p">];</span> <span class="c1">// 把父类的指针，强制类型转换</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - 面向对象基础(一)]]></title>
    <link href="http://away0x.github.io/blog/2018/02/04/oc-oop-basic/"/>
    <updated>2018-02-04T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/04/oc-oop-basic</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#o1">OC 多文件开发</a></li>
<li><a href="#o2">isa 指针</a></li>
<li><a href="#o3">实例变量(成员变量)</a></li>
<li><a href="#o4">方法</a></li>
<li><a href="#o5">私有变量和私有方法</a></li>
<li><a href="#o6">self</a></li>
<li><a href="#o7">NSObject</a></li>
<li><p><a href="#o8">例子</a></p></li>
<li><p>OC 中定义一个类分为声明和实现</p>

<ul>
<li>类可不声明只实现 (但不建议这样写)</li>
</ul>
</li>
<li>类名首字母应大写</li>
<li>OC 的类本质上就是一个结构体</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 参考 C 语言的结构体的使用过程</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Person</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Person</span> <span class="n">sp</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Person</span> <span class="o">*</span><span class="n">sip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">;</span> <span class="c1">// 结构体指针</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="o">*</span><span class="n">sip</span><span class="p">).</span><span class="n">age</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="o">*</span><span class="n">sip</span><span class="p">).</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wutong&quot;</span><span class="p">;</span>
</span><span class='line'><span class="c1">// 或者 (不能用 . 语法直接访问实例变量)</span>
</span><span class='line'><span class="n">sip</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
</span><span class='line'><span class="n">sip</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wt&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>所有的对象没有实例化之前都是 nil</li>
<li>OC 不支持方法重载但支持重写</li>
</ul>


<h1><h2 id="o1">OC 多文件开发</h2></h1>

<ul>
<li>多文件开发中，文件要使用谁，就导入谁的 h 文件即可

<ul>
<li>不能导入 m 文件，否则会报错</li>
</ul>
</li>
<li>通常把不同的类放到不同的文件中，每个类的声明和实现分开

<ul>
<li>声明写在 h 文件中</li>
<li>实现写在 m 文件中</li>
<li>类名是什么，文件名就是什么</li>
</ul>
</li>
</ul>


<h2>@interface, @implementation</h2>

<ul>
<li>@interface 写在 h 文件中，用于声明</li>
<li>@implementation 写在 m 文件中，用于实现具体逻辑</li>
</ul>


<h1><h2 id="o2">isa 指针</h2></h1>

<ul>
<li>每个对象都包含一个 isa 指针，这个指针指向当前对象所属的类</li>
<li><code>[p eat]</code> 表示给 p 所指向的对象发送一条 eat 消息，调用对象的 eat 方法

<ul>
<li>此时对象会顺着内部 isa 指针找到存储于类中的方法执行</li>
</ul>
</li>
<li>isa 是对象中的隐藏指针，指向这个对象的类</li>
<li>通过 isa 我们可在运行时知道当前对象是属于哪个类的</li>
</ul>


<h1><h2 id="o3">实例变量(成员变量)</h2></h1>

<ul>
<li>其写在 @interface 的大括号中</li>
<li>默认权限是受保护的，想外部访问需加上 @public</li>
<li>编写 OC 实例变量时，建议<strong>私有实例变量</strong>命名前加上 <code>_</code></li>
<li>实例变量不能离开类，不能在定义的同时初始化</li>
<li>实例变量只能通过对象来访问</li>
<li>实例变量不要以 new 开头，否则有可能导致未知错误</li>
</ul>


<h2>实例变量修饰符</h2>

<p>实例变量修饰符作用域: 从出现的位置，一直到下一个修饰符出现为止</p>

<ol>
<li>@public

<ol>
<li>可以在其他类中访问</li>
<li>可以在本类中访问</li>
<li>可在子类中访问父类 public 实例变量</li>
</ol>
</li>
<li>@private

<ol>
<li>不可在其他类中访问</li>
<li>可以在本类中访问</li>
<li>不可在子类中访问父类 private 实例变量</li>
</ol>
</li>
<li>@protected <strong>(没添加修饰符的都默认被该修饰符修饰)</strong>

<ol>
<li>不可在其他类中访问</li>
<li>可以在本类中访问</li>
<li>可在子类中访问父类 protected 实例变量</li>
</ol>
</li>
<li>@package

<ol>
<li>介于 public 和 private 之间</li>
<li>如在其他包中访问那么就是 private</li>
<li>如在当前包中访问那么就是 public</li>
<li>可在子类中访问父类 package 实例变量</li>
</ol>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="nc">Iphone</span> : <span class="bp">NSObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">_year</span><span class="p">;</span> <span class="c1">// protected 不公开，外部想访问需提供 setter/getter</span>
</span><span class='line'><span class="k">@public</span>        <span class="c1">// public 公开，外部可直接访问</span>
</span><span class='line'>    <span class="kt">float</span> <span class="n">f</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>全局变量、局部变量和实例变量的区别</h2>

<h3>全局变量</h3>

<ul>
<li>全局变量依托于文件</li>
<li>全局变量可先定义再初始化，或定义同时初始化</li>
<li>存储于<strong>静态区</strong>

<ul>
<li>程序一启动就会分配存储空间，直到程序结束才会释放</li>
</ul>
</li>
</ul>


<h3>局部变量</h3>

<ul>
<li>局部变量依托于函数或代码块</li>
<li>局部变量可先定义再初始化，或定义同时初始化</li>
<li>存储于<strong>栈</strong>

<ul>
<li>栈中的数据，系统会自动给我们释放</li>
</ul>
</li>
</ul>


<h3>实例变量</h3>

<ul>
<li>实例变量依托于类</li>
<li>实例变量不能在定义的同时初始化</li>
<li>存储于<strong>堆</strong> (当前对象对应的堆的存储空间中)

<ul>
<li>存储在堆中的数据，不会被自动释放，只能程序员手动释放</li>
</ul>
</li>
</ul>


<h1><h2 id="o4">方法</h2></h1>

<ul>
<li>C 语言函数，声明在 h 文件中，实现在 c 文件中</li>
<li>OC 方法，声明在 @interface 中，实现在 @implementation 中</li>
<li>OC 方法声明写在 @interface 的大括号下面，而不能写在其中</li>
<li>OC 方法支持重载</li>
<li>OC 中的方法，如没有形参不需要写 ()，这是因为 OC 方法中的 () 有其他用处，是用于扩住数据类型的</li>
<li>有参方法的冒号和外部参数名也是方法名的一部分</li>
<li><strong>方法可以没有声明只有实现</strong></li>
<li><strong>方法如声明了没实现，编译不会报错，运行时会报错</strong>

<ul>
<li>错误: <code>unrecognized selector send to class/instance</code> (发送了一个不能识别的消息)</li>
</ul>
</li>
<li>方法不要以 new 开头，否则有可能导致未知错误</li>
<li>OC 方法分类方法和实例方法</li>
</ul>


<h2>实例方法 (减号方法)</h2>

<ul>
<li>只能通过实例调用</li>
<li>方法中可以直接使用实例变量
8 方法中可调用其他实例方法(通过 self 调用)以及类方法(通过类调用)</li>
</ul>


<h2>类方法 (加号方法)</h2>

<ul>
<li>只能通过类名调用</li>
<li>方法中不能直接使用实例变量</li>
<li>不用每次使用方法都要创建对象开辟存储空间</li>
<li>调用类方法的效率会比调用实例方法高</li>
<li>方法中可调用其他类方法或者实例方法

<ul>
<li>类方法中调用实例方法，需要实例化类，通过实例调用</li>
<li>类方法中调用其他类方法

<ol>
<li>通过类调用</li>
<li>通过 self 调用</li>
</ol>
</li>
</ul>
</li>
<li>一般用于定义工具方法</li>
</ul>


<h1><h2 id="o5">私有变量和私有方法</h2></h1>

<h2>私有变量</h2>

<ul>
<li>实例变量即可在 interface 中定义也可在 implementation 中定义</li>
<li>implementation 中定义的实例变量在其他类中无法访问 (即使其是用 public 修饰的)</li>
<li>implementation 中定义的实例变量只能在本类中访问</li>
<li>implementation 中定义的实例变量不能和 interface 中定义的实例变量同名</li>
<li>因为在其他文件中通常都只是包含头文件而不会包含实现文件，所以在 m 文件中声明的实例变量是 private 的，这种情况下使用 public 也是徒劳的</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// Demo.m</span>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">Demo</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">_age</span><span class="p">;</span> <span class="c1">// 外界访问不到，即使是 public</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>私有方法</h2>

<ul>
<li>私有方法: 只有实现没有声明的方法</li>
<li>原则上: 私有方法只能在本类中才能调用

<ul>
<li>注意: OC 中没有真正的私有方法</li>
<li>因为 OC 的方法调用是通过消息机制，所以可通过 selector 访问到私有方法</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// p 的 test 是个私有方法，没在 interface 中声明</span>
</span><span class='line'><span class="p">[</span><span class="n">p</span> <span class="nl">performSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">test</span><span class="p">)];</span> <span class="c1">// 但仍可通过这种方式调用到</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="o6">self</h2></h1>

<ol>
<li>self 在类方法中，那么 self 就代表那个类</li>
<li>self 在实例方法中，那么 self 就代表调用当前实例方法的那个实例</li>
<li>可通过 self 调用实例变量 <code>self-&gt;_age</code></li>
<li><strong>注意点:</strong>

<ol>
<li>self 会自动区分类方法和实例方法，如果在类方法中使用 self 调用实例方法，那么会直接报错</li>
<li>不能再实例方法或类方法中利用 self 调用当前 self 所在的方法，会造成死循环</li>
</ol>
</li>
<li>使用场景:

<ol>
<li>可用于在实例方法之间的相互调用</li>
<li>可用于在类方法之间的相互调用</li>
<li>可用于区分成员变量和局部变量同名的情况 <code>self-&gt;实例变量</code></li>
</ol>
</li>
</ol>


<h1><h2 id="o7">NSObject</h2></h1>

<p>提供了创建对象实例的能力(new 方法)，所以需继承它</p>

<h1><h2 id="o8">例子</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 类声明</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">Iphone</span> : <span class="bp">NSObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 实例变量定义:</span>
</span><span class='line'>    <span class="c1">//     1. 默认情况下，OC 对象中的实例变量，调用时是不能直接访问的</span>
</span><span class='line'>    <span class="c1">//     2. 所以需要公开才可访问 @public 才可通过一个指向结构体的指针访问到</span>
</span><span class='line'>    <span class="c1">//     3. @public 下面的实例变量 cpu、cpu2 都会被公开</span>
</span><span class='line'><span class="k">@public</span>
</span><span class='line'>    <span class="kt">float</span> <span class="n">_cpu</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">float</span> <span class="n">_cpu2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 类方法声明</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">do</span><span class="p">;</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">do:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 实例方法声明</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">about</span><span class="p">;</span>    <span class="c1">// 无参无返回值</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">about2</span><span class="p">;</span> <span class="c1">// 无参有返回值</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 有参函数声明</span>
</span><span class='line'><span class="c1">//    - 参数的数据类型前面必须加上一个 &quot;:&quot; 号</span>
</span><span class='line'><span class="c1">//        - 注意: 当前这个方法名称为 &quot;printInt:&quot; 名称中是有冒号的</span>
</span><span class='line'><span class="c1">//        - 方法名为 &quot;printInt:&quot;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">printInt:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span><span class="p">;</span> <span class="c1">// 有一参有返回值</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//    - 定义多参方法 (无外部参数名)</span>
</span><span class='line'><span class="c1">//        - 方法名为 &quot;printInt::&quot;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">printInt:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span> <span class="o">:</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">content</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//    - 定义多参方法 (有外部参数名)</span>
</span><span class='line'><span class="c1">//        - 方法名为 &quot;printMessageWithNumber:andContent:&quot;</span>
</span><span class='line'><span class="c1">//        - 方法名像自然语言一样流畅，建议这样写</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">printMessageWithNumber:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span> <span class="nf">andContent:</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nv">content</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 类实现</span>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">Iphone</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 类方法的实现</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">do</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 类方法中调用实例方法 (不可直接调用)</span>
</span><span class='line'>    <span class="n">Iphone</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Iphone</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">p</span> <span class="n">about</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 类方法中调用其他类方法</span>
</span><span class='line'>    <span class="c1">// 1. 通过类</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Iphone</span> <span class="n">do2</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">// 2. 通过 self</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">do2</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">do:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 实例方法的实现</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">about</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 实例方法中可访问成员变量</span>
</span><span class='line'>    <span class="c1">// 1. 直接访问</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%f&quot;</span><span class="p">,</span> <span class="n">_cpu</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// 2. 通过 self 访问</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%f&quot;</span><span class="p">,</span> <span class="nb">self</span><span class="o">-&gt;</span><span class="n">_cpu</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 调用类方法</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Iphone</span> <span class="k">do</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 调用其他实例方法</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">about2</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">about2</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;啦啦啦&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">printInt:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">printInt:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">number</span> <span class="o">:</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">content</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%s&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">printMessageWithNumber</span><span class="p">:(</span><span class="kt">int</span><span class="p">)</span><span class="n">number</span> <span class="nl">andContent</span><span class="p">:(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">content</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d %s&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 类调用</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1. 实例化</span>
</span><span class='line'>    <span class="c1">// OC 中要想创建类实例，需给类发送消息 new (这个类需继承 NSObject)</span>
</span><span class='line'>    <span class="c1">//    1. new 创建出来的对象存储在堆中，堆中的数据不会自动释放 (栈才会)</span>
</span><span class='line'>    <span class="c1">// 实例化会做 3 件事情</span>
</span><span class='line'>    <span class="c1">//    1. 为 Iphone 类创建出来的对象分配存储空间 (在堆内存中开辟空间)</span>
</span><span class='line'>    <span class="c1">//    2. 初始化 Iphone 类创建出来的对象中的实例变量</span>
</span><span class='line'>    <span class="c1">//    3. 返回 Iphone 类创建出来的对象对应的地址</span>
</span><span class='line'>    <span class="c1">//        - 返回的地址是类的第 0 个属性的地址</span>
</span><span class='line'>    <span class="c1">//        - 并不是自己创建的那个，而是系统自动添加的名为 isa 的属性 (继承于 NSObject)</span>
</span><span class='line'>    <span class="c1">//        - 其实系统会在堆内存中开辟一块空间存储这个类，称其为类对象</span>
</span><span class='line'>    <span class="c1">//          类对象中存储了这个类的方法列表，isa 就指向这个类对象，</span>
</span><span class='line'>    <span class="c1">//          所以可通过其调用类的属性和方法</span>
</span><span class='line'>    <span class="c1">// OC 的类本质上就是一个结构体，所以 p 这个指针其实就是指向了一个结构体</span>
</span><span class='line'>    <span class="n">Iphone</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Iphone</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2. 访问类的公开实例变量 (不能用 . 语法直接访问实例变量)</span>
</span><span class='line'>    <span class="n">p</span><span class="o">-&gt;</span><span class="n">_cpu</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">;</span> <span class="c1">// 通过指针访问</span>
</span><span class='line'>    <span class="n">p</span><span class="o">-&gt;</span><span class="n">_cpu2</span> <span class="o">=</span> <span class="mf">3.6</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%f %f&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_cpu</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_cpu2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 3. 调用方法 (通过指针发送消息)</span>
</span><span class='line'>    <span class="c1">//    - 消息机制 (调用: 发送消息: [类/实例 方法名])</span>
</span><span class='line'>    <span class="c1">//    1. 调用类方法</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Iphone</span> <span class="k">do</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//    2. 调用实例方法</span>
</span><span class='line'>    <span class="c1">//      先在栈内存中找到 p 这个局部变量，其存储了实例对象的地址</span>
</span><span class='line'>    <span class="c1">//      然后通过这个地址在堆内存中找到实例对象的存储空间，并得到里面的 isa 指针</span>
</span><span class='line'>    <span class="c1">//      再通过 isa 里存放的地址，找到 Iphone 类对象的存储空间</span>
</span><span class='line'>    <span class="c1">//      再在存储空间的方法列表中找是否有名为 about 的方法，如有则执行</span>
</span><span class='line'>    <span class="p">[</span><span class="n">p</span> <span class="n">about</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="n">about2</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="nl">printInt</span><span class="p">:</span><span class="mi">123</span><span class="p">];</span> <span class="c1">// 调用有参数的方法</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">num2</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="nl">printInt</span><span class="p">:</span><span class="mi">123</span> <span class="o">:</span><span class="s">&quot;lalala&quot;</span><span class="p">];</span> <span class="c1">// 无外部参数名</span>
</span><span class='line'>    <span class="p">[</span><span class="n">p</span> <span class="nl">printMessageWithNumber</span><span class="p">:</span><span class="mi">123</span> <span class="nl">andContent</span><span class="p">:</span><span class="s">&quot;lalala&quot;</span><span class="p">];</span> <span class="c1">// 有外部参数名</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - Block]]></title>
    <link href="http://away0x.github.io/blog/2018/02/03/oc-block/"/>
    <updated>2018-02-03T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/03/oc-block</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#block-1">函数指针与 block</a></li>
<li><a href="#block-2">block 与 typedef</a></li>
<li><a href="#block-3">应用场景</a></li>
<li><a href="#block-4">注意事项</a></li>
<li><a href="#block-5">内存管理</a></li>
<li><a href="#block-6">循环引用</a></li>
<li><p><a href="#block-7">传递变量</a></p></li>
<li><p>block 是 iOS 中一种比较特殊的数据类型</p></li>
<li>block 是苹果官方特别推荐使用的数据类型，应用场景比较广泛

<ul>
<li>动画、多线程、集合遍历、网络请求回调</li>
</ul>
</li>
<li>block 的作用

<ul>
<li>用来保存某一段代码，可以在恰当的时间再取出来调用</li>
<li>功能类似于函数和方法</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// block 的格式</span>
</span><span class='line'><span class="err">返回值类型</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="err">变量名</span><span class="p">)(</span><span class="err">形参列表</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="err">形参列表</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="block-1">函数指针与 block</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="kt">void</span> <span class="nf">printA</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">chjar</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1. 调用函数</span>
</span><span class='line'>    <span class="n">printA</span><span class="p">();</span> <span class="c1">// &quot;a&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2. 指向函数 printA 的指针</span>
</span><span class='line'>    <span class="c1">//    - void 表指向的函数没有返回值</span>
</span><span class='line'>    <span class="c1">//    - () 代表指向的函数没有形参</span>
</span><span class='line'>    <span class="c1">//    - (*ap) 代表 ap 是一个指向函数的指针</span>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">)</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">ap</span> <span class="o">=</span> <span class="n">printA</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ap</span><span class="p">();</span> <span class="c1">// &quot;a&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ---------------------------------------------------</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 3. 定义 block</span>
</span><span class='line'>    <span class="c1">//    - block 和函数一样，可以没有(有)返回值，也没有(有)</span>
</span><span class='line'>    <span class="c1">//    - void 代表这个 block 将来保存的代码没有返回值</span>
</span><span class='line'>    <span class="c1">//    - () 代表这个 block 将来保存的代码没有形参</span>
</span><span class='line'>    <span class="c1">//    - (^printB) 代表 printB 是一个 block 变量，可以用于保存一段 block 代码</span>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">printB</span><span class="p">)</span> <span class="p">();</span> <span class="c1">// 定义</span>
</span><span class='line'>    <span class="n">ap2</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>           <span class="c1">// 保存 block 类型代码段</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">ap2</span><span class="p">();</span> <span class="c1">// &quot;b&quot; 执行 block</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="kt">int</span> <span class="p">(</span><span class="o">^</span><span class="n">sum</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;sum = %i&quot;</span><span class="p">,</span> <span class="n">sum</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span> <span class="c1">// &quot;sum = 50&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="block-2">block 与 typedef</h2></h1>

<p>使用 typedef 可简化 block 的声明</p>

<h2>函数指针使用 typedef</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 函数</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">minus</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">chjar</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">sumP</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span> <span class="c1">// 函数指针</span>
</span><span class='line'>    <span class="n">sumP</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">sumP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;3&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">minusP</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'>    <span class="n">minusP</span> <span class="o">=</span> <span class="n">minus</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">minusP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="kt">int</span> <span class="nf">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">minus</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用 typedef</span>
</span><span class='line'><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">calculte</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">chjar</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">calculte</span> <span class="n">sumP</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">sumP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;3&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">calculte</span> <span class="n">minusP</span> <span class="o">=</span> <span class="n">minus</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">minusP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>block 使用 typedef</h2>

<p>不能在方法代码中使用 typedef，必须写在文件的顶部或头文件中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">chjar</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="p">(</span><span class="o">^</span><span class="n">sum</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sum</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;3&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="p">(</span><span class="o">^</span><span class="n">minus</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'>    <span class="n">minus</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">minus</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;1&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 使用 typedef</span>
</span><span class='line'><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">^</span><span class="n">calculte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">chjar</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">calculte</span> <span class="n">sum</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;3&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">calculte</span> <span class="n">minus</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">minus</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// &quot;1&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="block-3">应用场景</h2></h1>

<ol>
<li>代码复用</li>
<li>高阶函数 (作为参数或返回值)</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">run:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">blockFunc</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">blockFunc</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span><span class="p">(</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;block...&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>类之间的通信

<ol>
<li>可替代代理委托</li>
<li>B 类中为 A 类的某个类型为 block 的属性赋值，A 类中会在某个事件中调用这个 block，从而实现跨类通信</li>
</ol>
</li>
</ol>


<h1><h2 id="block-4">注意事项</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 1. block 中可以访问外部的变量</span>
</span><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="p">};</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span> <span class="c1">// &quot;10&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2. block 中定义了和外部同名的变量，则 blick 内的优先</span>
</span><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span> <span class="c1">// &quot;20&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3. 默认情况下，不可以在 block 中修改外界变量的值</span>
</span><span class='line'><span class="c1">//    - 因为 block 中的变量和外界的变量不是用一个变量</span>
</span><span class='line'><span class="c1">//    - 如果 block 中访问了外界的变量，block 会将外界的这个变量拷贝一份到堆内存中</span>
</span><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// 修改了外部变量(实际上不是外部的变量)，报错</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span> <span class="c1">// 报错</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4. block 会在定义时拷贝外界使用到的变量</span>
</span><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="c1">// 在这里就将 a 的值拷贝了一份，此时 a 值为 10</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// 不会影响到 block 中拷贝的值</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span> <span class="c1">// &quot;10&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 5.如想在 block 中修改外界变量的值，必须在外界变量前加上 __block</span>
</span><span class='line'><span class="c1">//    - 这样如在 block 中修改了外界变量的值，会影响到外界变量的值</span>
</span><span class='line'><span class="c1">//    - 因为加了 __block 就是地址传递，所以可修改</span>
</span><span class='line'><span class="k">__block</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span>       <span class="c1">// &quot;20&quot;</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%i&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="c1">// &quot;20&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>block 可存储于堆中也可存储在栈中，默认在栈中

<ul>
<li>如对 block 进行 copy 操作，block 会转移到堆中</li>
<li>如 block 在栈中，block 中访问了外界的对象，那么不会对对象进行 retain 操作</li>
<li>但是如果 block 在堆中，block 中访问了外界的对象，那么会对外界的对象进行一次 retain 操作</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span> <span class="c1">// p 引用计数为 1</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%lu&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span> <span class="n">retainCount</span><span class="p">]);</span>    <span class="c1">// &quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="c1">// 由于下面用了 Block_copy，所以这里是 retain，p 引用计数 +1，为 2</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%lu&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span> <span class="n">retainCount</span><span class="p">]);</span> <span class="c1">// &quot;2&quot;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">Block_copy</span><span class="p">(</span><span class="n">myBlock</span><span class="p">);</span> <span class="c1">// copy 操作使 block 转移到堆中，此时 block 中访问外部变量会造成 retain</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">p</span> <span class="k">release</span><span class="p">];</span> <span class="c1">// p 引用计数 -1，此时为 1，释放不了</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 如在 block 中访问了外界的对象，一定要给对象加上 __block，只要加上了</span>
</span><span class='line'><span class="c1">// 哪怕 block 在堆中，也不会对外界的对象进行 retain</span>
</span><span class='line'>
</span><span class='line'><span class="k">__block</span> <span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span> <span class="c1">// p 引用计数为 1</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%lu&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span> <span class="n">retainCount</span><span class="p">]);</span>    <span class="c1">// &quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">myBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="c1">// 由于 p 定义时加上了 __block，不会有 retain，p 引用计数不变为 1</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%lu&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span> <span class="n">retainCount</span><span class="p">]);</span> <span class="c1">// &quot;1&quot;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">Block_copy</span><span class="p">(</span><span class="n">myBlock</span><span class="p">);</span>
</span><span class='line'><span class="n">myBlock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">p</span> <span class="k">release</span><span class="p">];</span> <span class="c1">// p 引用计数 -1，此时为 0，释放了</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="block-5">内存管理</h2></h1>

<p>block 也是一个对象</p>

<h2>MRC</h2>

<ul>
<li>只要 block 没有引用外部局部变量，block 放在全局区</li>
<li>只要 block 引用外部局部变量，block 则放在栈里</li>
<li>block 只能使用 copy，不能使用 retain，使用 retain，block 还是在栈中，使用 copy 才会到堆里</li>
</ul>


<h2>ARC</h2>

<ul>
<li>只要 block 引用外部局部变量，block 则放在堆里</li>
<li>block 使用 strong，最好不要使用 copy</li>
</ul>


<h1><h2 id="block-6">循环引用</h2></h1>

<p>block 造成循环引用: block 会默认对里面用到的所有外部对象变量全部强引用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">_block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="nb">self</span><span class="p">);</span> <span class="c1">// 强引用了 self，造成该实例不会销毁</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 解决: 使用弱引用</span>
</span><span class='line'><span class="k">__weak</span> <span class="k">typeof</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="n">_block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">weakSelf</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 由于 block 中可能要用到这个 weakSelf</span>
</span><span class='line'>    <span class="c1">// 而当用到时，可能这个弱指针被销毁了，所以可在定义一个强指针保存它</span>
</span><span class='line'>    <span class="k">__strong</span> <span class="k">typeof</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="n">strongSelf</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 之后就可使用这个 strongSelf 啦</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="block-7">传递变量</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 如果是局部变量，block 是值传递</span>
</span><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="p">};</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'><span class="n">block</span><span class="p">();</span> <span class="c1">// 3</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 如是静态变量，block 是指针传递</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="p">};</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'><span class="n">block</span><span class="p">();</span> <span class="c1">// 5</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 如是全局变量，block 是指针传递</span>
</span><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">block</span><span class="p">();</span> <span class="c1">// 5</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 如是 __block 修饰的变量，block 是指针传递</span>
</span><span class='line'><span class="k">__block</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="p">};</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'><span class="n">block</span><span class="p">();</span> <span class="c1">// 5</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - SEL, Id]]></title>
    <link href="http://away0x.github.io/blog/2018/02/02/oc-sel-id/"/>
    <updated>2018-02-02T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/02/oc-sel-id</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#sel">SEL</a></li>
<li><a href="#id">id</a></li>
</ul>


<h1><h2 id="sel">选择器类型 SEL</h2></h1>

<ul>
<li>SEL 类型代表着方法的签名，在类对象的方法列表中存储着该签名与方法代码的对应关系</li>
<li>每个类的方法列表都存储在类对象中</li>
<li>每个方法都有一个与之对应的 SEL 类型的对象</li>
<li>根据一个 SEL 对象就可以找到方法的地址，进而调用方法</li>
<li>SEL 类型的定义: <code>typedef struct obj_selector *SEL;</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="p">[</span><span class="n">p</span> <span class="n">test</span><span class="p">];</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">1. 首先把 test 这个方法名包装成 SEL 类型的数据</span>
</span><span class='line'><span class="cm">2. 根据 SEL 数据到该类的类对象上去找对应的方法的代码，找到就执行该代码</span>
</span><span class='line'><span class="cm">3. 没找到则根据类对象上父类的类对象指针，去父类的类对象中查找，找到则执行父类的代码</span>
</span><span class='line'><span class="cm">4. 如还没找到，一直向上找，直到基类 NSObject</span>
</span><span class='line'><span class="cm">5. 如都没找到就报错</span>
</span><span class='line'>
</span><span class='line'><span class="cm">**这个操作过程中有缓存，第一次找是一个个的找，很耗性能，之后再用，直接从缓存中取用</span>
</span><span class='line'><span class="cm">*/</span>
</span></code></pre></td></tr></table></div></figure>


<p>SEL 的作用 1: 配合对象/类来检查对象/类中有没有实现某一个方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="kt">SEL</span> <span class="n">sel</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">setAge</span><span class="p">:);</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 判断对象 p 中有没实现实例方法 &quot;setAge:&quot;</span>
</span><span class='line'><span class="kt">BOOL</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// respondsToSelector 注意点</span>
</span><span class='line'><span class="c1">// 1. 如果是通过一个对象来调用该方法那么会判断该对象有没实现该实例方法</span>
</span><span class='line'><span class="c1">// 2. 如果是通过类来调用，那么会判断该类有没实现这个类方法</span>
</span><span class='line'>
</span><span class='line'><span class="n">flag</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>SEL 的作用 2: 配合对象/类来调用某一个 SEL 方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 调用无参方法</span>
</span><span class='line'><span class="kt">SEL</span> <span class="n">sel</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">demo</span><span class="p">);</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 调用 p 对象中 sel 类型对应的方法，即 demo 方法</span>
</span><span class='line'><span class="p">[</span><span class="n">p</span> <span class="nl">performSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span> <span class="c1">// 相当于 [p demo]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 调用单参方法</span>
</span><span class='line'><span class="kt">SEL</span> <span class="n">sel2</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">demo</span><span class="p">:);</span>
</span><span class='line'><span class="p">[</span><span class="n">p</span> <span class="nl">performSelector</span><span class="p">:</span><span class="n">sel2</span> <span class="nl">withObject</span><span class="p">:</span><span class="s">@&quot;123&quot;</span><span class="p">];</span> <span class="c1">// withObject 就是要传递的参数</span>
</span><span class='line'><span class="c1">// 如用 performSelector 调用有参方法，那么参数必须是对象类型</span>
</span><span class='line'><span class="c1">//    即方法的形参必须是一个对象，因为 withObject 只能传递一个对象</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 调用多参方法 (performSelector 最多只能传递 2 个参数)</span>
</span><span class='line'><span class="kt">SEL</span> <span class="n">sel3</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">demo</span><span class="p">:</span><span class="nl">andOther</span><span class="p">:);</span>
</span><span class='line'><span class="p">[</span><span class="n">p</span> <span class="nl">performSelector</span><span class="p">:</span><span class="n">sel3</span> <span class="nl">withObject</span><span class="p">:</span><span class="s">@&quot;123&quot;</span> <span class="nl">withObject</span><span class="p">:</span><span class="s">@&quot;456&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>SEL 的作用 3: 配合对象将 SEL 类型作为方法的形参</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="nc">Demo</span> : <span class="bp">NSObject</span>
</span><span class='line'><span class="c1">// 调用传入对象的指定方法</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">useSel:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">obj</span> <span class="nf">andSel:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">Demo</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">useSel:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">obj</span> <span class="nf">andSel:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">obj</span> <span class="nl">performSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="n">Demo</span> <span class="o">*</span><span class="n">demo</span> <span class="o">=</span> <span class="p">[</span><span class="n">Demo</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="c1">//     调用 obj1 的 test 方法</span>
</span><span class='line'><span class="p">[</span><span class="n">demo</span> <span class="nl">useSel</span><span class="p">:</span><span class="n">obj1</span> <span class="nl">andSel</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">test</span><span class="p">)];</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="id">id</h2></h1>

<ul>
<li>id 是一个数据类型，并且是一个动态数据类型 (万能指针)</li>
</ul>


<h3>静态类型</h3>

<p>将一个指针变量定义为特定类的对象时，使用的是静态类型，在编译时就知道这个指针变量所属的类。这个变量总是存储特定类的对象</p>

<p>编译时已经知道类中有哪些属性和方法，如访问了不属于该静态类型的属性和方法，编译器会报错</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h3>动态类型</h3>

<p>这一特性是程序直到执行时才确定对象所属的类</p>

<p>编译时不知道其真实类型，在运行时才知道其真实类型。并且通过动态类型定义变量，如访问了不属于该动态类型的属性和方法，编译器不会报错 (躲过了编译器的检查)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// id 的定义中，已经包好了 *，所以自己不用写</span>
</span><span class='line'><span class="c1">// id 指针只能指向 OC 中的对象</span>
</span><span class='line'><span class="c1">// 当 id 指向的变量调用了本项目中所有类都没有的方法，编译器会报错</span>
</span><span class='line'><span class="c1">// id 类型不能使用 . 语法。因为 . 语法是编译时特性，id 是运行时特性</span>
</span><span class='line'><span class="kt">id</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>id == NSObject *</code>，但是数据类型不一样

<ol>
<li>id 是动态类型</li>
<li><code>NSObject *</code> 是静态类型</li>
</ol>
</li>
</ul>


<h3>动态类型的作用</h3>

<ol>
<li>调用子类方法而不用强转

<ol>
<li>通过静态类型定义变量，不能调用子类特有的方法(除非强转成子类)
 <code>objectivec
 id obj = [Father new];
 [obj child_function]; // 可调用子类特有的方法
</code></li>
<li>通过动态类型定义变量，可以调用子类特有的方法(不用强转)</li>
</ol>
</li>
<li>可通过动态数据类型调用私有方法(即只有实现没有声明的方法)</li>
</ol>


<h3>动态类型的缺点</h3>

<ul>
<li>由于动态类型可调用任意方法，所以有可能调用到不属于自己的方法，而编译不会报错，所以可能导致运行时报错</li>
<li>虽说 id 类型可存储任何类型的对象，但不要养成滥用这种通用类型的习惯

<ol>
<li>如没使用<strong>多态</strong>尽量使用静态类型

<ul>
<li>用于多态，可减少代码量，避免调用子类特有的方法需要强制类型转换</li>
</ul>
</li>
<li>静态类型可以更早的发现错误 (在编译阶段而不是运行阶段)】</li>
<li>静态类型可提高程序的可读性</li>
<li><strong>使用动态类型前最好判断其真实类型</strong> (避免运行时错误)</li>
</ol>
</li>
</ul>


<h3>动态类型判断真实类型</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// </span>
</span><span class='line'><span class="c1">// 方法1: isKindOfClass:classObj 判断实例对象是否是这个类或者这个类的子类的实例</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="n">Student</span> <span class="o">*</span><span class="n">stu</span> <span class="o">=</span> <span class="p">[</span><span class="n">Student</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="kt">BOOL</span> <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="n">Person</span> <span class="k">class</span><span class="p">]];</span> <span class="c1">// YES</span>
</span><span class='line'><span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">stu</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="n">Person</span> <span class="k">class</span><span class="p">]];</span>    <span class="c1">// YES</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// isMemberOfClass:classObj 判断是否是这个类的实例</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="n">Student</span> <span class="o">*</span><span class="n">stu</span> <span class="o">=</span> <span class="p">[</span><span class="n">Student</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="kt">BOOL</span> <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="nl">isMemberOfClass</span><span class="p">:[</span><span class="n">Person</span> <span class="k">class</span><span class="p">]];</span> <span class="c1">// YES</span>
</span><span class='line'><span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">stu</span> <span class="nl">isMemberOfClass</span><span class="p">:[</span><span class="n">Person</span> <span class="k">class</span><span class="p">]];</span>    <span class="c1">// NO (是子类不是实例)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="kt">id</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="k">if</span> <span class="p">([</span><span class="n">obj</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="n">Person</span> <span class="k">class</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">obj</span> <span class="n">person_function</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ObjectiveC - 基础]]></title>
    <link href="http://away0x.github.io/blog/2018/02/01/oc-basic/"/>
    <updated>2018-02-01T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2018/02/01/oc-basic</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#c">OC vs. C</a></li>
<li><a href="#type">数据类型</a></li>
<li><a href="#if-loop">流程语句</a></li>
<li><a href="#function">函数</a></li>
<li><a href="#oop">面向对象</a></li>
<li><a href="#catch">异常处理</a></li>
<li><a href="#import">import</a></li>
<li><a href="#output">输入输出</a></li>
<li><a href="#hello">Hello World</a></li>
</ul>


<h1><h2 id="c">OC vs. C</h2></h1>

<ul>
<li>Objective-C 是一门面向对象的计算机语言</li>
<li>它在 C 语言的基础上增加了一层最小的面向对象语法</li>
<li>OC 完全兼容 C 语言，可在 OC 代码中混入 C/C++ 代码

<ul>
<li>并且可将 C 语言的源文件和 OC 的源文件组合在一起生成可执行文件</li>
</ul>
</li>
</ul>


<p>源代码文件拓展名对比</p>

<table>
<thead>
<tr>
<th style="text-align:right;">  </th>
<th style="text-align:center;"> 头文件 </th>
<th style="text-align:left;"> 实现文件 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;"> c </td>
<td style="text-align:center;"> .h </td>
<td style="text-align:left;"> .c </td>
</tr>
<tr>
<td style="text-align:right;"> c++ </td>
<td style="text-align:center;"> .h </td>
<td style="text-align:left;"> .cpp </td>
</tr>
<tr>
<td style="text-align:right;"> oc </td>
<td style="text-align:center;"> .h </td>
<td style="text-align:left;"> .m </td>
</tr>
<tr>
<td style="text-align:right;"> oc &amp; c++ </td>
<td style="text-align:center;"> .h </td>
<td style="text-align:left;"> .mm </td>
</tr>
</tbody>
</table>


<p>OC 与 C</p>

<table>
<thead>
<tr>
<th>OC </th>
<th> C</th>
</tr>
</thead>
<tbody>
<tr>
<td>面向对象 </td>
<td> 数据类型</td>
</tr>
<tr>
<td>@property 与 @synthesize </td>
<td> 常量变量</td>
</tr>
<tr>
<td>类方法与实例方法 </td>
<td> 运算符</td>
</tr>
<tr>
<td>self 关键字 </td>
<td> 流程语句</td>
</tr>
<tr>
<td>点语法、@selector </td>
<td> 函数</td>
</tr>
<tr>
<td>category </td>
<td> 进制</td>
</tr>
<tr>
<td>protocol </td>
<td> 一维/多维数组</td>
</tr>
<tr>
<td>copy </td>
<td> 指针</td>
</tr>
<tr>
<td>block </td>
<td> 结构体</td>
</tr>
<tr>
<td>autoreleasepool </td>
<td> 预处理指令</td>
</tr>
<tr>
<td>Foundation </td>
<td> 文件操作</td>
</tr>
<tr>
<td>常用结构体 </td>
<td> &hellip;</td>
</tr>
<tr>
<td>KVC、KVO </td>
<td> /</td>
</tr>
<tr>
<td>&hellip; </td>
<td> /</td>
</tr>
</tbody>
</table>


<p>关键字 (OC 中新增的关键字大部分都以 @ 符号开头)</p>

<table>
<thead>
<tr>
<th>OC </th>
<th> C</th>
</tr>
</thead>
<tbody>
<tr>
<td>@interface </td>
<td> auto</td>
</tr>
<tr>
<td>@implementation </td>
<td> double</td>
</tr>
<tr>
<td>@end </td>
<td> int</td>
</tr>
<tr>
<td>@public </td>
<td> struct</td>
</tr>
<tr>
<td>@protected </td>
<td> break</td>
</tr>
<tr>
<td>@private </td>
<td> else</td>
</tr>
<tr>
<td>@selector </td>
<td> long</td>
</tr>
<tr>
<td>@try </td>
<td> switch</td>
</tr>
<tr>
<td>@catch </td>
<td> case</td>
</tr>
<tr>
<td>@throw </td>
<td> enum</td>
</tr>
<tr>
<td>@finally </td>
<td> register</td>
</tr>
<tr>
<td>@protocol </td>
<td> typedef</td>
</tr>
<tr>
<td>@optional </td>
<td> char</td>
</tr>
<tr>
<td>@required </td>
<td> extern</td>
</tr>
<tr>
<td>@class </td>
<td> return</td>
</tr>
<tr>
<td>@property </td>
<td> union</td>
</tr>
<tr>
<td>@synthesize </td>
<td> const</td>
</tr>
<tr>
<td>@dynamic </td>
<td> float</td>
</tr>
<tr>
<td>BOOL </td>
<td> short</td>
</tr>
<tr>
<td>Class </td>
<td> unsigned</td>
</tr>
<tr>
<td>SEL </td>
<td> continue</td>
</tr>
<tr>
<td>YES </td>
<td> for</td>
</tr>
<tr>
<td>NO </td>
<td> signed</td>
</tr>
<tr>
<td>id </td>
<td> void</td>
</tr>
<tr>
<td>self </td>
<td> default</td>
</tr>
<tr>
<td>super </td>
<td> goto</td>
</tr>
<tr>
<td>nil </td>
<td> sizeof</td>
</tr>
<tr>
<td>atomic </td>
<td> volatile</td>
</tr>
<tr>
<td>nonatomic </td>
<td> do</td>
</tr>
<tr>
<td>retain </td>
<td> if</td>
</tr>
<tr>
<td>assign </td>
<td> while</td>
</tr>
<tr>
<td>copy </td>
<td> static</td>
</tr>
<tr>
<td>block </td>
<td> /</td>
</tr>
<tr>
<td>_ </td>
<td> /</td>
</tr>
</tbody>
</table>


<h1><h2 id="type">数据类型</h2></h1>

<blockquote><p>加粗为 OC 相对于 C 新增的</p></blockquote>

<h2>基本数据类型</h2>

<ul>
<li>整型 (short int long <strong>BOOL</strong>)

<ul>
<li>布尔型 BOOL: 取值为 YES(1)、NO(0)</li>
</ul>
</li>
<li>字符型 (char)</li>
<li>浮点型 (float double)</li>
</ul>


<h2>Block 类型 (OC 新增)</h2>

<ul>
<li><strong>block</strong> (代码块数据类型)</li>
</ul>


<h2>构造类型</h2>

<p>数组、结构体、枚举、共用体</p>

<h2>指针类型</h2>

<ul>
<li><strong>class</strong></li>
<li><strong>id</strong> (动态对象类型、万能指针)</li>
<li><strong>NSObject</strong> (对象类型)</li>
</ul>


<h2>空类型 void</h2>

<h2>特殊类型 (OC 新增)</h2>

<ul>
<li><strong>SEL</strong> (选择器类型)</li>
<li><strong>nil</strong></li>
</ul>


<h1><h2 id="if-loop">流程语句</h2></h1>

<ul>
<li>C 语言中使用的流程语句 OC 都可使用

<ul>
<li>if switch while do-while for break continue &hellip;</li>
</ul>
</li>
</ul>


<p>新增语句</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 增强型 for 循环</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span> <span class="k">in</span> <span class="n">arr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="function">函数</h2></h1>

<ul>
<li>C 语言中函数的声明与实现

<ul>
<li>声明: <code>int sum(int a, int b);</code></li>
<li>实现: <code>int sum(int a, int b) { return a + b }</code></li>
</ul>
</li>
<li>OC 中函数的声明与实现

<ul>
<li>声明: <code>- (int)sum:(int)a andB:(int)b;</code></li>
<li>实现: <code>- (int)sum:(int)a andB:(int)b { return a + b  }</code></li>
</ul>
</li>
<li><strong>注意:</strong> 方法只能写在类里面，而函数可以写在任何地方</li>
</ul>


<h1><h2 id="oop">面向对象</h2></h1>

<blockquote><p>仅介绍特殊语法</p></blockquote>

<h2>属性生成器</h2>

<ul>
<li>@property</li>
<li>@synthesize</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 声明属性</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 合成属性</span>
</span><span class='line'><span class="k">@synthesize</span> <span class="n">name</span> <span class="o">=</span> <span class="n">_name</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>分类</h2>

<ul>
<li>分类是横向拓展、继承是竖向扩展</li>
<li>使用分类拓展类，无需子类化</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@interface</span> <span class="bp">NSString</span> <span class="nl">(MyNSString)</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">encryptWithMD5</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>协议</h2>

<ul>
<li>类似 C#、Java 中的接口</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@protocol</span> <span class="nc">MyProtocol</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">myProtocolMethod</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="import">异常处理</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@try</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span> <span class="k">@catch</span><span class="p">(</span><span class="bp">NSException</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span> <span class="k">@finally</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="import">import</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// C</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// OC</span>
</span><span class='line'><span class="c1">// 和 include 功能一样，将文件拷贝到 import 的位置</span>
</span><span class='line'><span class="c1">// import 同一个文件多次也只会导入一次</span>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>import 功能和 include 一样，但 import 更强大</li>
<li>import 可防止重复导入，可不用像使用 C 的 include 一样，程序员得去写头文件卫士来预防这个问题</li>
<li><code>#import</code> 导入的文件名需要加上双引号或尖括号

<ul>
<li>双引号: 编译器会先在项目目录下查找相应的头文件</li>
<li>尖括号: 编译器会先在预先设定好的标准目录下查找相应的头文件</li>
</ul>
</li>
</ul>


<h1><h2 id="output">输入输出</h2></h1>

<h2>输入</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="c1">// 接收用户控制台的输入信息</span>
</span><span class='line'><span class="c1">// 获取整型数据</span>
</span><span class='line'><span class="kt">int</span> <span class="n">userSelect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">userSelect</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 获取字符串类型</span>
</span><span class='line'><span class="kt">char</span> <span class="n">ans</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">rewind</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span><span class='line'><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ans</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>log</h2>

<ul>
<li>NSLog 支持 C 语言的字符串，但支持得不是很好

<ul>
<li>如打印中文的 C 语言字符串，可能输出乱码，或输出空白</li>
</ul>
</li>
</ul>


<p>打印类型时可用如 NSStringFromCGPoint 这些函数辅助，CGRect 等类型同</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="bp">CGPoint</span> <span class="n">point</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">NSStringFromCGPoint</span><span class="p">(</span><span class="n">point</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>在函数内打印时可使用 <strong>func</strong> 打印出当前函数名</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello C!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Hello OC!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 输出 C 语言字符串</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">content</span> <span class="o">=</span> <span class="s">&quot;lalala&quot;</span><span class="err">；</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%s&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>去除控制台输出运行的时间和项目名称</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="cp">#define NSLog(FORMAT, ...) fprintf(stderr,&quot;%s&quot;,[[NSString stringWithFormat:FORMAT, ##__VA_ARGS__] UTF8String])</span>
</span></code></pre></td></tr></table></div></figure>


<h1><h2 id="hello">Hello World</h2></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 可见 OC 是兼容 C 的</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello C!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// NSLog 会自动换行</span>
</span><span class='line'>    <span class="c1">// NSLog 在输出时会附加一些系统信息</span>
</span><span class='line'>    <span class="c1">// NSLog 和 printf 接收的参数不一样</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Hello OC!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[从零开始实现前端模板引擎]]></title>
    <link href="http://away0x.github.io/blog/2017/05/17/fd-template/"/>
    <updated>2017-05-17T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2017/05/17/fd-template</id>
    <content type="html"><![CDATA[<!-- more -->


<blockquote><p>本文总结了 3 种实现模板引擎的方式，最后将编写一个 类似于 underscore.template 的模板插件</p></blockquote>

<ul>
<li><a href="#replace">replace</a></li>
<li><a href="#tplstr">模板字符串</a></li>
<li><a href="#function">new Function</a></li>
<li><a href="https://github.com/Away0x/learning-template">github</a></li>
</ul>


<h1><h2 id="replace">replace</h2></h1>

<h2>介绍</h2>

<p>replace 是字符串提供的一个超级强大的方法，这里只介绍简单的使用，更多详细的语法参见下面提供的链接
- 一参可为 <code>字符串</code> 或 <code>正则</code>:
    - 为正则时有两种情况: <code>普通匹配模式</code> 和 <code>全局匹配模式</code>:
        - 全局匹配模式下，若二参为函数，则该函数在每次匹配时都会被调用
- 二参可为 <code>字符串</code> 或 <code>一个用于生成字符串的函数</code>:
    - 当为字符串时:
        - 可在字符串中使用 特殊替换字符 ($n &hellip;)
    - 当为函数时:
        - 函数中不能用 特殊替换字符
        - 一参为正则匹配的文本
        - 倒数第二参为匹配到的子字符串在原字符串中的偏移量
        - 最后一参为被匹配的原始字符串
        - 其余参数为正则中每个分组匹配到的文本</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">replacer</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// match 为 &#39;abc12345#$*%&#39;        : 正则匹配的文本</span>
</span><span class='line'>    <span class="c1">// p1,p2,p3 分别为 abc 12345 #$*% : 即每个小组匹配到的文本, pn 表示有 n 个小组</span>
</span><span class='line'>    <span class="c1">// offset 为 0                    : 匹配到的子字符串在原字符串中的偏移量。</span>
</span><span class='line'>    <span class="c1">//      （比如，如果原字符串是&#39;abcd&#39;，匹配到的子字符串时&#39;bc&#39;，那么这个参数将是1）</span>
</span><span class='line'>    <span class="c1">// string 为 &#39;abc12345#$*%&#39;       : 被匹配的原始字符串</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 注意正则中的 括号 ，这里分有 3个组</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">newString</span> <span class="o">=</span> <span class="s1">&#39;abc12345#$*%&#39;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^\d]*)(\d*)([^\w]*)/</span><span class="p">,</span> <span class="nx">replacer</span><span class="p">);</span>
</span><span class='line'><span class="c1">// newString =&gt; &#39;abc - 12345 - #$*%&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>以下是各种情况下的具体案例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 最基础的使用</span>
</span><span class='line'><span class="s1">&#39;123&#39;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="c1">// &#39;A23&#39;</span>
</span><span class='line'><span class="s1">&#39;lalala 2Away0x2&#39;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/2(.*)2/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">)</span> <span class="c1">// &#39;lalala Away0x&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// trim</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">trim</span> <span class="o">=</span> <span class="nx">str</span> <span class="o">=&gt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^\s*)|(\s*$)/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">trim</span><span class="p">(</span><span class="s1">&#39;  abc    &#39;</span><span class="p">)</span> <span class="c1">// &#39;abc&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// format</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">str</span> <span class="o">=&gt;</span>
</span><span class='line'>    <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>        <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/{(\d+)}/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">args</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;lalal{0}wowowo{1}hahah{2}&#39;</span><span class="p">)(</span><span class="s1">&#39;-A-&#39;</span><span class="p">,</span> <span class="s1">&#39;-B-&#39;</span><span class="p">,</span> <span class="s1">&#39;-C&#39;</span><span class="p">)</span> <span class="c1">// lala-A-wowo-B-haha-C</span>
</span></code></pre></td></tr></table></div></figure>


<h2>原理</h2>

<p>先在模板中预留占位(  )，再将对应的数据填入</p>

<h2>实现</h2>

<p>要求1: 可填充简单数据</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">//g</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">p</span><span class="p">])</span>
</span><span class='line'><span class="nx">tpl</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="s1">&#39;tpl&#39;</span><span class="p">})</span> <span class="c1">// &#39;&lt;div&gt;tpl&lt;/div&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>要求2: 可填充嵌套数据</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 可根据占位符  中的 &quot;.&quot; 来获得数据的依赖路径，从而得到对应的数据</span>
</span><span class='line'><span class="c1">// 由于 使用 &quot;.&quot; 连接，所以其前后应为合法的变量名，因此需重新构造正则</span>
</span><span class='line'><span class="cm">/* 合法变量名</span>
</span><span class='line'><span class="cm">*    - 开头可为字符和少量特殊字符: [a-zA-Z$_]</span>
</span><span class='line'><span class="cm">*    - 余部还可是数字:            [a-zA-Z$_0-9]</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="c1">// 除开头外还需匹配 连接符 &quot;.&quot; ,因此最终正则为: //g</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">tpl</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">reg</span> <span class="o">=</span> <span class="sr">//g</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 全局匹配模式下，replace 的回调在每次匹配时都会执行,</span>
</span><span class='line'>    <span class="c1">// p 为占位符中的变量,该例为 data.a</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">reg</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1">// [&#39;data&#39;, &#39;a&#39;]</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">result</span>  <span class="o">=</span> <span class="nx">data</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">]</span> <span class="c1">// 得到路径最末端的数据</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">||</span> <span class="nx">match</span> <span class="c1">// 需转成字符串，因为可能遇到 0, null 等数据</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">tpl</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="s1">&#39;tpl&#39;</span><span class="p">}})</span> <span class="c1">// &#39;&lt;div&gt;tpl&lt;/div&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>最终代码:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">tpl</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">reg</span> <span class="o">=</span> <span class="sr">//g</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">reg</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">result</span>  <span class="o">=</span> <span class="nx">data</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">]</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">||</span> <span class="nx">match</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>优缺点</h3>

<ul>
<li>优点: 简单</li>
<li>缺点: 无法在模板中使用表达式，所有数据都得事先计算好再填入，且填充的数据应为基础类型，灵活性差，难以满足复杂的需求</li>
</ul>


<h3>资料</h3>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/replace">详细语法</a></p>

<h1><h2 id="tplstr">模板字符串</h2></h1>

<h2>介绍</h2>

<ul>
<li>模板字符串包裹在 反引号(Esc按钮下面那个) 中，其中可通过 ${} 的语法进行插值</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 特性一:多行</span>
</span><span class='line'><span class="err">`</span><span class="mi">123123</span>
</span><span class='line'> <span class="mi">23213</span><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 特性二: 字符串中可插值</span>
</span><span class='line'><span class="cm">/* 作为一门伪函数式编程语言，js 的很多语法都可以返回数据:</span>
</span><span class='line'><span class="cm">*    - 表达式: 各种运算符表达式，三目(可用来替代简单的判断语句)</span>
</span><span class='line'><span class="cm">*    - 函数:  封装各种复杂的逻辑，最后返回一个值即可</span>
</span><span class='line'><span class="cm">*    - 方法:  如一些有返回值的数据方法</span>
</span><span class='line'><span class="cm">*       - 最强大的如数组的 map, filter ...</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="c1">// 以下字符串都等于 &#39;123tpl456&#39;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str1</span> <span class="o">=</span> <span class="err">`</span><span class="mi">123</span><span class="nx">$</span><span class="p">{</span><span class="s1">&#39;tpl&#39;</span><span class="p">}</span><span class="mi">456</span><span class="err">`</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str2</span> <span class="o">=</span> <span class="err">`</span><span class="mi">123</span><span class="nx">$</span><span class="p">{</span><span class="kc">false</span> <span class="o">||</span> <span class="s1">&#39;tpl&#39;</span><span class="p">}</span><span class="mi">456</span><span class="err">`</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str3</span> <span class="o">=</span> <span class="err">`</span><span class="mi">123</span><span class="nx">$</span><span class="p">{</span><span class="kc">true</span> <span class="o">?</span> <span class="s1">&#39;tpl&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span><span class="mi">456</span><span class="err">`</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str4</span> <span class="o">=</span> <span class="err">`</span><span class="mi">123</span><span class="nx">$</span><span class="p">{</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="s1">&#39;tpl&#39;</span><span class="p">}())</span> <span class="p">}</span><span class="mi">456</span><span class="err">`</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="s1">&#39;tpl&#39;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str5</span> <span class="o">=</span> <span class="err">`</span><span class="mi">123</span><span class="nx">$</span><span class="p">{</span> <span class="nx">fn</span><span class="p">()</span> <span class="p">}</span><span class="mi">456</span><span class="err">`</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str6</span> <span class="o">=</span> <span class="err">`</span><span class="mi">123</span><span class="nx">$</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span><span class="mi">456</span><span class="err">`</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">([</span><span class="nx">str1</span><span class="p">,</span> <span class="nx">str2</span><span class="p">,</span> <span class="nx">str3</span><span class="p">,</span> <span class="nx">str4</span><span class="p">,</span> <span class="nx">str5</span><span class="p">,</span> <span class="nx">str6</span><span class="p">].</span><span class="nx">every</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span> <span class="o">===</span> <span class="s1">&#39;123tpl456&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 特性三: 模板函数</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">tag</span> <span class="p">(</span><span class="nx">strArr</span><span class="p">,</span> <span class="p">...</span><span class="nx">vals</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">strArr</span><span class="p">,</span> <span class="nx">vals</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">tag</span><span class="err">`</span><span class="nx">Hello</span> <span class="nx">$</span><span class="p">{</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span> <span class="p">}</span> <span class="nx">world</span> <span class="nx">$</span><span class="p">{</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">b</span><span class="p">}</span><span class="err">`</span>
</span><span class='line'><span class="c1">// strArr =&gt; [&#39;Hello &#39;, &#39; world &#39;, &#39;&#39;]</span>
</span><span class='line'><span class="c1">// vals   =&gt; [15, 30]  (${}里的值)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>案例</h2>

<ul>
<li>由于直接用模板字符串当模板引擎了，所以就直接写个组件吧

<ul>
<li><a href="http://codepen.io/Away0x/pen/dvEGpL">演示</a></li>
<li><a href="https://github.com/Away0x/learning-template/blob/master/src/tplstr.pagination/page.js">代码</a></li>
</ul>
</li>
<li>用这种方法写模板需注意的是一定要细分组件(很函数式，有种写 jsx 的既视感)</li>
</ul>


<h3>资料</h3>

<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings">详细语法</a></li>
<li><a href="http://www.pdosgk.com/index.php/home/news/show/id/80442.html">相关文章</a></li>
</ul>


<h1><h2 id="function">new Function</h2></h1>

<h2>介绍</h2>

<ul>
<li>Function 是 js 提供的一个用于构造 Function 对象的构造函数</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 普通函数</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">log</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Away0x&#39;</span><span class="p">,</span> <span class="s1">&#39;lalala&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1">// Function 构造函数</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;console.log(user, msg)&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Away0x&#39;</span><span class="p">,</span> <span class="s1">&#39;lalala&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>实现</h2>

<ul>
<li>大多数前端模板引擎都是用这种方式实现的，其原理在于运用了 js Function 对象可将字符串解析为函数的能力。</li>
<li>一个普通模板引擎的工作步骤大致如下</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 1. 编写模板</span>
</span><span class='line'><span class="p">{</span><span class="err">@</span> <span class="k">if</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">con</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="p">)</span> <span class="p">{</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">ifififififif</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="p">{</span><span class="err">@</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">elseelseelseelse</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="p">{</span><span class="err">@</span> <span class="p">}</span> <span class="err">@</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 2. 由模板生成函数体字符串</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">functionbody</span> <span class="o">=</span> <span class="err">`</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">con</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">tpl</span> <span class="o">+=</span> <span class="s1">&#39;&lt;p&gt;ifififififif&lt;/p&gt;&#39;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">tpl</span> <span class="o">+=</span> <span class="s1">&#39;&lt;p&gt;ifififififif&lt;/p&gt;&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">tpl</span>
</span><span class='line'><span class="err">`</span>
</span><span class='line'><span class="c1">// 3. 通过 Function 解析字符串并生成函数</span>
</span><span class='line'><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">functionbody</span><span class="p">)(</span><span class="nx">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>由此可见，只要将 {@  @} 里的字符串内容生成 js 语句，而其余内容之前加上 一个 &lsquo;tpl += &rsquo; 即可。</li>
</ul>


<p>实现代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">tplStr</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">//g</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="s1">&#39;+(${p})+&#39;</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/{@(.+?)@}/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="s1">&#39;; ${p}; tpl += &#39;</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="err">`</span><span class="kd">var</span> <span class="nx">tpl</span><span class="o">=</span><span class="s1">&#39;${tplStr}&#39;</span><span class="p">;</span> <span class="k">return</span> <span class="nx">tpl</span><span class="p">;</span><span class="err">`</span><span class="p">)(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 测试</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="err">`</span>
</span><span class='line'>    <span class="p">{</span><span class="err">@</span> <span class="k">if</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">con</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="p">)</span> <span class="p">{</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">ifififififif</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="err">@</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">elseelseelseelse</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="err">@</span> <span class="p">}</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">{</span><span class="err">@</span> <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p"></span> <span class="o">:</span> <span class="p"></span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="err">@</span> <span class="p">}</span> <span class="err">@</span><span class="p">}</span>
</span><span class='line'><span class="err">`</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">con</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span> <span class="nx">list</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">76</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">8</span><span class="p">]}</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">tpl</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'><span class="c1">// &lt;p&gt;ifififififif&lt;/p&gt;</span>
</span><span class='line'><span class="c1">// &lt;p&gt;0 : 1&lt;/p&gt;&lt;p&gt;1 : 2&lt;/p&gt;&lt;p&gt;2 : 3&lt;/p&gt;&lt;p&gt;3 : 4&lt;/p&gt;&lt;p&gt;4 : 5&lt;/p&gt;&lt;p&gt;5 : 76&lt;/p&gt;&lt;p&gt;6 : 87&lt;/p&gt;&lt;p&gt;7 : 8&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ok, 一个最最简单的模板引擎就已经完成了，支持在模板中嵌入 js 语句，虽然只有不到10行，但还是挺强大的对不。</p>

<h2>拓展</h2>

<h3>实现模板类</h3>

<p>为了能够更好的使用，将前面的代码抽成一个类。
- 需求:
    - 标识符格式有可能和后端模板引擎冲突，因此应实现成可配置的
    - <code>{@  @}</code>: 用于嵌套逻辑语句
    - <code>`: 用于嵌套变量或表达式
    - 在模板中应能添加注释，注释有两种:
        -</code><!-- --><code>: 会输出
        -</code>{#  #}`: 这种注释会在编译时被忽略，即只在模板中可见</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">class</span> <span class="nx">Tpl</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">defaultConfig</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">signs</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">varSign</span><span class="o">:</span>       <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>    <span class="c1">// 变量/表达式</span>
</span><span class='line'>              <span class="nx">evalSign</span><span class="o">:</span>      <span class="p">[</span><span class="s1">&#39;{@&#39;</span><span class="p">,</span> <span class="s1">&#39;@}&#39;</span><span class="p">],</span>    <span class="c1">// 语句</span>
</span><span class='line'>                <span class="nx">commentSign</span><span class="o">:</span>   <span class="p">[</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">,</span> <span class="s1">&#39;--&gt;&#39;</span><span class="p">],</span> <span class="c1">// 普通注释</span>
</span><span class='line'>                <span class="nx">noCommentSign</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;{#&#39;</span><span class="p">,</span> <span class="s1">&#39;#}&#39;</span><span class="p">]</span>     <span class="c1">// 忽略注释</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 可通过配置来修改标识符</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">defaultConfig</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// [&#39;&#39;] =&gt; //g 构造正则</span>
</span><span class='line'>        <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;(.+?)&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// 模板解析</span>
</span><span class='line'>    <span class="nx">_compile</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="c1">// 注释</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">noCommentSign</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">commentSign</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="s1">&#39;+&#39;</span><span class="c">&lt;!--</span> <span class="nx">$</span><span class="p">{</span><span class="nx">p</span><span class="p">}</span> <span class="o">--&gt;</span><span class="s1">&#39;+&#39;</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>            <span class="c1">// 表达式/变量</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">varSign</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="s1">&#39;+(${p})+&#39;</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>            <span class="c1">// 语句</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">evalSign</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">let</span>  <span class="nx">exp</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">return</span> <span class="err">`</span><span class="s1">&#39;; ${exp}; tpl += &#39;</span><span class="err">`</span>
</span><span class='line'>          <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="err">`</span><span class="kd">var</span> <span class="nx">tpl</span><span class="o">=</span><span class="s1">&#39;${tpl}&#39;</span><span class="p">;</span> <span class="k">return</span> <span class="nx">tpl</span><span class="p">;</span><span class="err">`</span><span class="p">)(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>    <span class="c1">// 入口</span>
</span><span class='line'>    <span class="nx">compile</span> <span class="p">(</span><span class="nx">tplStr</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_compile</span><span class="p">(</span><span class="nx">tplStr</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">tpl</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nx">Tpl</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">tpl</span><span class="p">().</span><span class="nx">compile</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// 得到</span>
</span></code></pre></td></tr></table></div></figure>


<h3>注释的 BUG</h3>

<p>上面的代码在解析一些特殊模板注释(如下)时会出错 <code>&lt;!--  --&gt;</code> (由于注释中有标识符，因此会将 a 作为变量解析，会报未定义错误)</p>

<p>解决: 在解析注释时，如注释里有标识符，则将其先替换成其他符号，等语句变量的解析完成时，再替换回来</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">commentSign</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">exp</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\{\&lt;\}\&gt;]/g</span><span class="p">,</span> <span class="nx">match</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="o">&amp;*&amp;</span><span class="nx">$</span><span class="p">{</span><span class="nx">match</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()}</span><span class="o">&amp;*&amp;</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="err">`</span><span class="s1">&#39;+&#39;</span><span class="c">&lt;!--</span> <span class="nx">$</span><span class="p">{</span><span class="nx">exp</span><span class="p">}</span> <span class="o">--&gt;</span><span class="s1">&#39;+&#39;</span><span class="err">`</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="c1">// ... 解析变量和语句</span>
</span><span class='line'><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&amp;\*\&amp;(.*?)\&amp;\*\&amp;/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span>  <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>语法模式</h3>

<p>在模板里写 js 好烦呀，各种 &lsquo;{&rsquo; 乱飞，有些模板提供了更好看的语法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{@ if data.con &gt; 20 @} // if (data.con &gt; 20) {
</span><span class='line'>    <span class="nt">&lt;p&gt;</span>ifififififif<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>{@ elif data.con === 20 @} // } else if (data.con === 20) {
</span><span class='line'>    <span class="nt">&lt;p&gt;</span>elseelseelseelseifififififif<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>{@ else @} // } else {
</span><span class='line'>    <span class="nt">&lt;p&gt;</span>elseelseelseelse<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>{/@ if @} // }
</span><span class='line'>// for (var index = 0; index <span class="nt">&lt; data.list.length</span><span class="err">;</span> <span class="na">index</span><span class="err">++)</span> <span class="err">{</span> <span class="na">var</span> <span class="na">item =</span><span class="err"> </span><span class="s">data.list[index]</span>
</span><span class='line'><span class="err">{@</span> <span class="na">each</span> <span class="na">data</span><span class="err">.</span><span class="na">list</span> <span class="na">as</span> <span class="na">item</span> <span class="err">@}</span>
</span><span class='line'>    <span class="err">&lt;</span><span class="na">p</span><span class="nt">&gt;</span>循环  次: <span class="nt">&lt;/p&gt;</span>
</span><span class='line'>{/@ each @}
</span></code></pre></td></tr></table></div></figure>


<p>其实就是在解析语句时多做一些处理而已:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 配置中增加 syntax 属性，默认 false, 其为 true 是开启 语法模式</span>
</span><span class='line'><span class="c1">// 配置中增加语法模式结束语句的标识符: endEvalSign: [&#39;{/@&#39;, &#39;@}&#39;]</span>
</span><span class='line'><span class="c1">// 给 Tpl 类添加方法，用于 语法模式 的语句解析</span>
</span><span class='line'><span class="nx">_syntax</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">exp</span> <span class="o">=</span> <span class="nx">str</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;if&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// if (xx) {</span>
</span><span class='line'>        <span class="nx">exp</span> <span class="o">=</span> <span class="err">`</span><span class="k">if</span> <span class="p">(</span> <span class="nx">$</span><span class="p">{</span><span class="nx">arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)}</span> <span class="p">)</span> <span class="p">{</span><span class="err">`</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;else&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// } else {</span>
</span><span class='line'>        <span class="nx">exp</span> <span class="o">=</span> <span class="s1">&#39;} else {&#39;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;elif&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// } else if (xx) {</span>
</span><span class='line'>        <span class="nx">exp</span> <span class="o">=</span> <span class="err">`</span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">$</span><span class="p">{</span><span class="nx">arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)}</span> <span class="p">)</span> <span class="p">{</span><span class="err">`</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;each&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// for (var index = 0, len = xx.length; index &lt; len; index++) { var item = xx[index]</span>
</span><span class='line'>        <span class="nx">exp</span> <span class="o">=</span> <span class="err">`</span><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]}.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]}[</span><span class="nx">index</span><span class="p">]</span><span class="err">`</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">exp</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 修改 _compile 解析语句的 replace</span>
</span><span class='line'><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">evalSign</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span>  <span class="nx">exp</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
</span><span class='line'>                               <span class="c1">// 语法模式</span>
</span><span class='line'>    <span class="nx">exp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">syntax</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">_syntax</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="o">:</span> <span class="nx">exp</span>
</span><span class='line'>    <span class="k">return</span> <span class="err">`</span><span class="s1">&#39;; ${exp}; tpl += &#39;</span><span class="err">`</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="c1">// 增加结束标识的解析 {/@ if @}  {/@ each @}</span>
</span><span class='line'><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">endEvalSign</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">&quot;&#39;} tpl += &#39;&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>过滤器</h3>

<ul>
<li>很多模板引擎中都有提供很多好用的过滤器:

<ul>
<li>字符串转大写的过滤器: <code>&lt;p&gt;tpl&lt;/p&gt; =&gt; &lt;p&gt;TPL&lt;/p&gt;</code></li>
<li>字符串转大写的过滤器(支持流式): <code>&lt;p&gt;tpl&lt;/p&gt;</code></li>
</ul>
</li>
</ul>


<p>现在我们来编写这个拓展</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 由于过滤器是对于变量的操作，所以只需在解析变量标识符的过程中做一下处理即可</span>
</span><span class='line'><span class="c1">//  =&gt; 无过滤器直接返回，  有过滤器则调用 Filters 类中对应的过滤器函数</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 过滤器函数</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Filters</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">upper</span><span class="o">:</span> <span class="nx">str</span> <span class="o">=&gt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 解析 </span>
</span><span class='line'><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">signs</span><span class="p">.</span><span class="nx">varSign</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">filterIndex</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">p</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">filterIndex</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 有过滤器</span>
</span><span class='line'>        <span class="kr">const</span>
</span><span class='line'>            <span class="nx">arr</span>     <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">()),</span>
</span><span class='line'>            <span class="nx">filters</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">[],</span>
</span><span class='line'>            <span class="nx">oldVal</span>  <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">val</span> <span class="o">=</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">curVal</span><span class="p">,</span> <span class="nx">filterName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">Filters</span><span class="p">[</span><span class="nx">filterName</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="err">`没有</span> <span class="nx">$</span><span class="p">{</span><span class="nx">filterName</span><span class="p">}</span> <span class="err">过滤器`</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="err">`</span><span class="nx">Filters</span><span class="p">[</span><span class="s1">&#39;${filterName}&#39;</span><span class="p">](</span><span class="nx">$</span><span class="p">{</span><span class="nx">curVal</span><span class="p">})</span><span class="err">`</span>
</span><span class='line'>        <span class="p">},</span> <span class="nx">oldVal</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="err">`</span><span class="s1">&#39;+(${val})+&#39;</span><span class="err">`</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用</span>
</span><span class='line'><span class="c1">// &lt;h1&gt;&lt;/h1&gt; // =&gt; &#39;LPT&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>至此该模板引擎就完成了，总结下功能:

<ul>
<li>支持在模板中使用 js 语句</li>
<li>支持自定义标识符</li>
<li>支持更简洁的语法模式</li>
<li>支持过滤器</li>
</ul>
</li>
</ul>


<h3>其他</h3>

<ul>
<li>虽然这个模板工具还是有点简陋，比如没有个很友善的报错机制，不支持 include 等功能，但日常跑跑小项目什么的已经足够强大了</li>
<li><a href="http://codepen.io/Away0x/pen/JWqgLw">演示</a></li>
<li><a href="https://github.com/Away0x/learning-template/blob/master/src/eval/tpl.js">代码</a></li>
</ul>


<h3>资料</h3>

<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">详细语法</a></li>
<li><a href="http://blog.jobbole.com/56689/">只有20行Javascript代码！手把手教你写一个页面模板引擎</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[从零开始实现前端表单验证插件]]></title>
    <link href="http://away0x.github.io/blog/2017/03/11/fd-form-validator/"/>
    <updated>2017-03-11T08:00:00+08:00</updated>
    <id>http://away0x.github.io/blog/2017/03/11/fd-form-validator</id>
    <content type="html"><![CDATA[<!-- more -->


<blockquote><p>本文使用 es6、不依赖任何第三方库实现一个简单的表单验证插件 <a href="https://github.com/Away0x/baidu-ife/blob/master/yaoyao/lesson_2/index.html">github</a></p></blockquote>

<h1>效果</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form_group tel&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>手机<span class="nt">&lt;/label&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;tel&quot;</span> <span class="na">name=</span><span class="s">&quot;tel&quot;</span> <span class="na">id=</span><span class="s">&quot;tel&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 配置</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;#tel&#39;</span><span class="p">,</span> <span class="c1">// 验证目标</span>
</span><span class='line'>  <span class="nx">message</span><span class="o">:</span> <span class="p">{</span> <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;.tel p&#39;</span><span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="s1">&#39;手机格式正确&#39;</span> <span class="p">},</span> <span class="c1">// 验证信息显示的地方</span>
</span><span class='line'>  <span class="nx">validators</span><span class="o">:</span> <span class="p">[</span> <span class="c1">// 验证规则数组</span>
</span><span class='line'>    <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;tel&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;手机格式错误&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>代码结构</h1>

<ul>
<li>验证插件分为 <code>验证类Validator</code>，和 <code>验证规则validators</code>

<ul>
<li><code>验证类Validator</code>: 为主逻辑，负责接受表单的配置并对表单执行相应的验证规则。</li>
<li><code>验证规则validators</code>: 其内封装了大量的验证规则，供表单选用。</li>
</ul>
</li>
</ul>


<p>每个验证规则有着相同的结构，它们接收 表单的 value 返回验证结果和报错信息。例子如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 针对手机号的验证规则</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">tel</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">}</span><span class="o">=</span><span class="p">{})</span> <span class="o">=&gt;</span>
</span><span class='line'><span class="p">({</span>
</span><span class='line'>  <span class="nx">status</span><span class="o">:</span> <span class="sr">/^1[3|4|5|7|8][0-9]{9}$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="c1">// 验证状态</span>
</span><span class='line'>  <span class="nx">message</span> <span class="c1">// 报错信息</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h2>验证类 Validator</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">class</span> <span class="nx">Validator</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 接受配置 validatorConfig: 验证器配置, targetConfig: 针对于表单的配置</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * validatorConfig {}</span>
</span><span class='line'><span class="cm">  *   - error   每个表单验证失败时的函数   Function</span>
</span><span class='line'><span class="cm">  *   - success 每个表单验证成功时的函数   Function</span>
</span><span class='line'><span class="cm">  *   - reset   对表单执行重置操作时的函数 Function</span>
</span><span class='line'><span class="cm">  * targetConfig [{}, {}, ...] -&gt; 各个表单的配置</span>
</span><span class='line'><span class="cm">  *   - target        验证目标的选择器  String(Selector)</span>
</span><span class='line'><span class="cm">  *   - message       验证信息的配置  Object</span>
</span><span class='line'><span class="cm">  *     - target      验证信息显示位置的选择器  String(Selector)</span>
</span><span class='line'><span class="cm">  *  - placeholder 验证信息的默认值，重置时会显示该文本 String</span>
</span><span class='line'><span class="cm">  *  - success     验证成功时会显示该文本   String</span>
</span><span class='line'><span class="cm">  *  - validators    验证规则的配置  [{}, {}, ...] -&gt; 各个验证规则的配置</span>
</span><span class='line'><span class="cm">  *    - name        验证规则的名字 (validators[key])  String</span>
</span><span class='line'><span class="cm">  *    - args        验证规则的配置参数  Object</span>
</span><span class='line'><span class="cm">  *      - message   必有 该规则验证失败的显示文本  String</span>
</span><span class='line'><span class="cm">  *      - ...       该验证规则的其他配置参数  Any (各验证规则不同)</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>  <span class="c1">// 验证主逻辑</span>
</span><span class='line'>  <span class="nx">_check</span> <span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>  <span class="c1">// 单个表单的验证 (只对单个表单执行 _check)</span>
</span><span class='line'>  <span class="nx">run</span> <span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>  <span class="c1">// 执行全部表单的验证 (对所有要验证的表单执行 _check)</span>
</span><span class='line'>  <span class="nx">runAll</span> <span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>  <span class="c1">// 重置表单为初始状态</span>
</span><span class='line'>  <span class="nx">reset</span> <span class="p">()</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>验证主逻辑 _check</h3>

<p>其接受 验证表单的配置，并执行相应验证逻辑
如接受了以下配置:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">target</span><span class="o">:</span>  <span class="s1">&#39;#tel&#39;</span><span class="p">,</span> <span class="c1">// 验证目标</span>
</span><span class='line'>  <span class="c1">// 验证信息显示的地方</span>
</span><span class='line'>  <span class="nx">message</span><span class="o">:</span>  <span class="p">{</span> <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;.tel p&#39;</span><span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="s1">&#39;手机格式正确&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nx">validators</span><span class="o">:</span> <span class="p">[</span> <span class="c1">// 验证规则数组</span>
</span><span class='line'>    <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;tel&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;手机格式错误&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>需实现功能如下:</p>

<ol>
<li>对目标表单(target)执行配置中指定的验证规则 (validators: 此次配置中只有一个验证规则)</li>
<li>如验证规则中有 required ，则说明该表单为必填项，必须进行表单验证。</li>
<li>如验证规则中无 required ，则说明该表单为选填项，只在有输入时才进行表单验证。(该例配置为选填)</li>
<li>当验证成功时需在 message.target 处显示 message.success 的文本。</li>
<li>当验证失败时需在 message.target 处显示 验证规则中的指定 的文本。</li>
<li>失败文本显示优先级同验证规则配置的先后顺序。</li>
</ol>


<p>以下是具体实现:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">_check</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span>
</span><span class='line'>      <span class="nx">validatorCfg</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_validatorConfig</span><span class="p">,</span>    <span class="c1">// 验证器配置</span>
</span><span class='line'>      <span class="nx">$target</span>       <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">target</span><span class="p">),</span>         <span class="c1">// 验证的表单</span>
</span><span class='line'>      <span class="nx">val</span>           <span class="o">=</span> <span class="nx">$target</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>            <span class="c1">// 验证的 value</span>
</span><span class='line'>      <span class="nx">$message</span>      <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">target</span><span class="p">),</span> <span class="c1">// 验证信息显示的地方</span>
</span><span class='line'>      <span class="nx">ownValidators</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">validators</span><span class="p">,</span>        <span class="c1">// 所有验证规则</span>
</span><span class='line'>      <span class="nx">result</span>        <span class="o">=</span> <span class="p">[]</span>                        <span class="c1">// 失败信息数组</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">required</span> <span class="o">=</span> <span class="kc">false</span> <span class="c1">// 不是必填项的话，只在有输入内容时进行检查 (默认为不必填)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 遍历执行验证器</span>
</span><span class='line'>    <span class="nx">ownValidators</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">validator</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">validator</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;required&#39;</span><span class="p">)</span> <span class="nx">required</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// 必填</span>
</span><span class='line'>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">Validators</span><span class="p">[</span><span class="nx">validator</span><span class="p">.</span><span class="nx">name</span><span class="p">](</span><span class="nx">val</span><span class="p">,</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">args</span><span class="p">)</span> <span class="c1">// 执行验证器</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 如验证失败，则存储失败信息</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">message</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">required</span> <span class="o">&amp;&amp;</span> <span class="nx">val</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="c1">// 可跳过检验</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 有错误信息</span>
</span><span class='line'>      <span class="nx">validatorCfg</span><span class="p">.</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">validatorCfg</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">$target</span><span class="p">)</span> <span class="c1">// 失败回调</span>
</span><span class='line'>      <span class="nx">$message</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span> <span class="c1">// 验证通过</span>
</span><span class='line'>      <span class="nx">validatorCfg</span><span class="p">.</span><span class="nx">success</span> <span class="o">&amp;&amp;</span> <span class="nx">validatorCfg</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">$target</span><span class="p">)</span> <span class="c1">// 成功回调</span>
</span><span class='line'>      <span class="nx">$message</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">success</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// 单个验证 需传入要验证 input 的 id</span>
</span><span class='line'><span class="nx">run</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 得到当前要验证的表单的配置</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">curConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_targetConfig</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">config</span> <span class="o">=&gt;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">target</span> <span class="o">===</span> <span class="err">`#</span><span class="nx">$</span><span class="p">{</span><span class="nx">target</span><span class="p">}</span><span class="err">`</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">_check</span><span class="p">(</span><span class="nx">curConfig</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 执行全局验证</span>
</span><span class='line'><span class="nx">runAll</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">_targetConfig</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_check</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 重置表单</span>
</span><span class='line'><span class="nx">reset</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">_targetConfig</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">config</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span>
</span><span class='line'>      <span class="nx">$target</span>  <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">target</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">$message</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$target</span><span class="p">.</span><span class="nx">value</span>        <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>    <span class="nx">$message</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">placeholder</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">_validatorConfig</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_allTarget</span> <span class="p">)</span> <span class="c1">// 重置回调</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>自此我们的验证插件就写完了，可自行在 validators 中编写更多的验证规则</p>

<h1>继续优化</h1>

<ul>
<li>提交表单时应需得到所有表单的验证状态，全通过则提交。</li>
<li>目前失败信息提示过于单一。</li>
<li>如表单验证中需与后台通信(如验证用户名是否注册),那么验证器应该支持异步的验证规则。</li>
<li>目前会执行所有验证规则，可选择在验证规则失败时，就不再往下继续验证了，以提高性能。</li>
</ul>

]]></content>
  </entry>
  
</feed>
