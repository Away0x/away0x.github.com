---
layout: post
title: "Rust - Test"
date: 2021-10-09 08:00:00 +0800
comments: true
categories: rust
---

- Rust ä¸­ä¸€ä¸ªæµ‹è¯•å°±æ˜¯ä¸€ä¸ªå‡½æ•°, éœ€è¦ä½¿ç”¨ test å±æ€§è¿›è¡Œæ ‡æ³¨
- ä½¿ç”¨ `cargo test` å‘½ä»¤è¿è¡Œæ‰€æœ‰æµ‹è¯•å‡½æ•°
    - Rust ä¼šæ„å»ºä¸€ä¸ª Test Runner å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒä¼šè¿è¡Œæ ‡æ³¨äº† test çš„å‡½æ•°ï¼Œå¹¶æŠ¥å‘Šå…¶è¿è¡Œæ˜¯å¦æˆåŠŸ

## å¦‚ä½•è¿è¡Œæµ‹è¯•
```bash
# å¹¶è¡Œè¿è¡Œæ‰€æœ‰æµ‹è¯•å‡½æ•°
# - æµ‹è¯•æˆåŠŸæ—¶: ä¸æ˜¾ç¤ºæ‰€æœ‰è¾“å‡º(å¦‚ println!)ï¼Œä½¿è¯»å–ä¸æµ‹è¯•ç»“æœç›¸å…³çš„è¾“å‡ºæ›´å®¹æ˜“
# - æµ‹è¯•å¤±è´¥æ—¶ä¼šæ˜¾ç¤ºå¦‚ println! è¿™æ ·çš„è¾“å‡º
cargo test

# å‘½ä»¤è¡Œå‚æ•°åˆ†ä¸ºä»¥ä¸‹ä¸¤å¤§ç±»
# 1. é’ˆå¯¹ cargo test çš„å‚æ•°: ç´§è·Ÿ cargo test ä¹‹å
cargo test --help # è¾“å‡º cargo test çš„å¯ç”¨çš„å‚æ•°

# 2. é’ˆå¯¹æµ‹è¯•å¯æ‰§è¡Œç¨‹åº: æ”¾åœ¨ -- ä¹‹å
cargo test -- --help # è¾“å‡º -- ä¹‹åçš„æ‰€æœ‰å¯ç”¨å‚æ•°
```
- å¹¶è¡Œè¿è¡Œæµ‹è¯•: é»˜è®¤ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å¹¶è¡Œè¿è¡Œ
    - é€Ÿåº¦å¿«
    - è¦è€ƒè™‘å¹¶å‘å½±å“ï¼Œéœ€è¦ç¡®ä¿æµ‹è¯•ä¹‹é—´ä¸ä¼šäº’ç›¸ä¾èµ–ï¼Œå¹¶ä¸”æ­¥ä¾èµ–äºæŸä¸ªå…±äº«çŠ¶æ€(ç¯å¢ƒã€å·¥ä½œç›®å½•ã€ç¯å¢ƒå˜é‡ç­‰ç­‰)

```bash
# --test-threads å‚æ•°
# - ä¼ é€’ç»™äºŒè¿›åˆ¶æ–‡ä»¶
# - ğŸ™…ä»¥å¹¶è¡Œæ–¹å¼è¿è¡Œæµ‹è¯•ï¼Œæˆ–å‘å¯¹çº¿ç¨‹æ•°è¿›è¡Œç»†ç²’åº¦æ§åˆ¶
# - å¯ä½¿ç”¨è¯¥å‚æ•°ï¼Œåé¢è·Ÿçº¿ç¨‹çš„æ•°é‡
cargo test -- --test-threads=1 # å•çº¿ç¨‹è¿è¡Œæµ‹è¯•
```
- æ˜¾ç¤ºè¾“å‡º
    - é»˜è®¤æƒ…å†µä¸‹, æµ‹è¯•é€šè¿‡ï¼ŒRust çš„ test åº“ä¼šæ•è·æ‰€æœ‰æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºçš„å†…å®¹ (å¦‚ `println!`)

```bash
# å³ä½¿æµ‹è¯•é€šè¿‡ï¼Œä¹Ÿæ˜¾ç¤ºæ ‡å‡†è¾“å‡º
cargo test -- --show-output
```
- é€‰æ‹©æ€§çš„è¿è¡Œæµ‹è¯•

```bash
# æ ¹æ®æµ‹è¯•å‡½æ•°çš„åç§°æŒ‡å®šè¿è¡Œçš„æµ‹è¯•
cargo test test_one_fn # è¿è¡Œå•ä¸ªæµ‹è¯•
# å¯æŒ‡å®šæµ‹è¯•åçš„ä¸€éƒ¨åˆ† (æ¨¡å—åä¹Ÿå¯ä»¥) æ¥åŒ¹é…å¹¶è¿è¡Œå¤šä¸ªæµ‹è¯•
cargo test test_ # ä¼šè¿è¡Œæµ‹è¯•å‡½æ•°åå­—ä¸­å¸¦æœ‰ test_ çš„æµ‹è¯•
```

## å¦‚ä½•ç¼–å†™æµ‹è¯•
```rust
#[test]
fn test_fn() {}
```
- `assert!` å®ï¼Œæ¥è‡ªæ ‡å‡†åº“ï¼Œç”¨æ¥ç¡®å®šæŸä¸ªçŠ¶æ€æ˜¯å¦ä¸º true
    - true: æµ‹è¯•é€šè¿‡
    - false: è°ƒç”¨ `panic!`ï¼Œæµ‹è¯•å¤±è´¥
- ä½¿ç”¨ `assert_eq!` å’Œ `assert_ne!` æµ‹è¯•ç›¸ç­‰æ€§
    - åˆ¤æ–­ä¸¤ä¸ªå‚æ•°æ˜¯å¦ç›¸ç­‰/ä¸ç­‰
    - å®é™…ä¸Šï¼Œå®ƒä»¬ä½¿ç”¨çš„å°±æ˜¯ `==` å’Œ `!=` è¿ç®—ç¬¦
    - æ–­è¨€å¤±è´¥: è‡ªåŠ¨æ‰“å°å‡ºä¸¤ä¸ªå‚æ•°çš„å€¼ (è¦æ±‚å‚æ•°å®ç°äº† PartialEq å’Œ Debug Traits)

```rust
#[derive(Debug)]
pub struct Rectangle {
    length: u32,
    width: u32,
}

impl Rectangle {
    pub fn can_hold(&self, other: &Rectangle) -> bool {
        self.length > other.length && self.width > other.width
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn larger_can_hold_smaller() {
        let larger = Rectangle { length: 8, width: 7 };
        let smaller = Rectangle {
            length: 5,
            width: 1,
        };

        assert!(larger.can_hold(&smaller)); // äºŒå‚å¯ä¼ è‡ªå®šä¹‰ä¿¡æ¯
        // assert!(something, "{} {}", formart_param1, formart_param2);
    }
}
```
- ä½¿ç”¨ `should_panic` å±æ€§æµ‹è¯•æ˜¯å¦å‘ç”Ÿäº†ææ…Œ (éªŒè¯ä»£ç æ˜¯å¦å‘ç”Ÿäº† panic)

```rust
// å‡½æ•° panic: æµ‹è¯•é€šè¿‡ï¼Œå¦åˆ™å¤±è´¥
#[cfg(test)]
mod tests {
    use super::*;

    // should_panic ä¿®é¥°çš„å‡½æ•° panic äº†æµ‹è¯•æ‰ä¼šé€šè¿‡
    // å¯ should_panic(expected = "xxxx")ï¼ŒéªŒè¯ panic æ—¶ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯å¦åŒ…å«äº† expected æ³¨æ˜çš„å­—ç¬¦ä¸²
    #[test]
    #[should_panic]
    fn test_fn() {...}
}
```
- æµ‹è¯•ä¸­ä½¿ç”¨ `Result<T, E>`
    - æ— éœ€ panic, å¯ä½¿ç”¨ `Result<T, E>` ä½œä¸ºè¿”å›ç±»å‹ç¼–å†™æµ‹è¯•
    - è¿”å› Ok æµ‹è¯•é€šè¿‡ï¼Œè¿”å› Err æµ‹è¯•å¤±è´¥

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn it_works() -> Result<(), String> {
        if 2 + 2 == 4 {
            Ok(())
        } else {
            Err(panic!(String::from("two plus two does not equal four")))
        }
    }
}
```
- å¿½ç•¥æŸäº›æµ‹è¯•ï¼Œè¿è¡Œå‰©ä½™çš„æµ‹è¯•
    - ä½¿ç”¨ ignore å±æ€§è¿›è¡Œæ ‡è®°

```rust
// è¿è¡Œ cargo testï¼Œåªä¼šè¿è¡Œ fn1 è¿™ä¸ªæµ‹è¯•
// "cargo test -- --ignored": åªè¿è¡Œè¢«æ ‡è®° ignore çš„æµ‹è¯•
#[cfg(test)]
mod tests {
    #[test]
    fn fn1() {...}

    #[test]
    #[ignore]
    fn fn2() {...}
}
```

## å¦‚ä½•ç»„ç»‡æµ‹è¯•
### å•å…ƒæµ‹è¯•
- ä¸€æ¬¡å¯¹ä¸€ä¸ªæ¨¡å—è¿›è¡Œéš”ç¦»çš„æµ‹è¯•
- å¯æµ‹è¯• private æ¥å£
- ä¸€èˆ¬å•å…ƒæµ‹è¯•å’Œè¢«æµ‹è¯•çš„ä»£ç éƒ½æ”¾åœ¨ src ç›®å½•ä¸‹çš„åŒä¸€ä¸ªæ–‡ä»¶ä¸­
- çº¦å®šæ¯ä¸ªæºä»£ç æ–‡ä»¶éƒ½å»ºç«‹ tests æ¨¡å—æ¥æ”¾æµ‹è¯•å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ `#[cfg(test)]` æ ‡æ³¨ tests æ¨¡å—
    - ä½¿ç”¨ `#[cfg(test)]` æ ‡æ³¨åï¼Œåªæœ‰è¿è¡Œ `cargo test` æ‰ç¼–è¯‘å’Œè¿è¡Œä»£ç ï¼Œè€Œ `cargo build` åˆ™ä¸ä¼š
    - cfg: Configuration, å‘Šè¯‰ Rust ä¸‹é¢çš„æ¡ç›®åªæœ‰åœ¨æŒ‡å®šçš„é…ç½®é€‰é¡¹ä¸‹æ‰è¢«åŒ…å«

```rust
// åªåœ¨ cargo test æ‰ä¼šæŠŠä»¥ä¸‹ä»£ç æ‹‰å…¥ç¼–è¯‘èŒƒå›´
fn fn1() {...}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn it_works() {
        fn1(); // å¯è°ƒç”¨ç§æœ‰å‡½æ•°
        assert_eq!(4, 2 + 2);
    }
}
```

### é›†æˆæµ‹è¯•
- åœ¨åº“å¤–éƒ¨ï¼Œå’Œå…¶ä»–å¤–éƒ¨ä»£ç ä¸€æ ·ä½¿ç”¨ä½ çš„ä»£ç 
- åªèƒ½è®¿é—® public æ¥å£
- å¯èƒ½åœ¨æ¯ä¸ªæµ‹è¯•ä¸­ä½¿ç”¨åˆ°å¤šä¸ªæ¨¡å—
- é›†æˆæµ‹è¯•å’Œè¢«æµ‹è¯•æ–‡ä»¶åœ¨ä¸åŒçš„ç›®å½•ï¼Œä¸éœ€è¦ `#[cfg(test)]` æ ‡æ³¨
- **é›†æˆæµ‹è¯•æ”¾åœ¨ src åŒçº§çš„ tests ç›®å½•ä¸‹**ï¼Œtests ç›®å½•ä¸‹çš„æ¯ä¸ªæµ‹è¯•æ–‡ä»¶éƒ½æ˜¯å•ç‹¬çš„ä¸€ä¸ª crate
    - è¿™äº›æ–‡ä»¶æ­¥å…±äº«è¡Œä¸º (ä¸ src ä¸‹çš„æ–‡ä»¶è§„åˆ™ä¸åŒ)
    - å¦‚æœéœ€è¦åœ¨ tests æ–‡ä»¶ä¸‹å…±äº«é€»è¾‘ï¼Œå¯ä»¥å»ºç«‹å­ç›®å½•ï¼Œåœ¨å…¶ä¸­ç¼–å†™é€šç”¨é€»è¾‘ (tests ä¸‹çš„å­ç›®å½•ä¸ä¼šè¢«å½“æˆæµ‹è¯•æ–‡ä»¶è¿è¡Œ)

```rust
// adder/tests/integration_test.rs
use adder; // é¡¹ç›®çš„åå­—

// ç”±äº tests ç›®å½•åªä¼šåœ¨æ‰§è¡Œ cargo test å‘½ä»¤çš„æ—¶å€™è¿è¡Œï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨ #[cfg(test)] æ ‡æ³¨
#[test]
fn it_adds_two() {
    assert_eq!(4, adder::add_two(2))
}
```
- è¿è¡ŒæŒ‡å®šçš„é›†æˆæµ‹è¯• `cargo test æµ‹è¯•å‡½æ•°å`
- è¿è¡ŒæŸä¸ªæµ‹è¯•æ–‡ä»¶å†…çš„æ‰€æœ‰æµ‹è¯•: `cargo test --test æ–‡ä»¶å`

#### é’ˆå¯¹ binary crate çš„é›†æˆæµ‹è¯•
- å¦‚æœé¡¹ç›®æ—¶ binary crateï¼Œåªå«æœ‰ `src/main.rs` æ²¡æœ‰ `src/lib.rs`
    - ä¸èƒ½åœ¨ tests ç›®å½•ä¸‹åˆ›å»ºé›†æˆæµ‹è¯•
    - tests æ— æ³•æŠŠ `main.rs` çš„å‡½æ•°å¯¼å…¥ä½œç”¨åŸŸ
- åªæœ‰ library crate æ‰èƒ½æš´éœ²å‡½æ•°ç»™å…¶ä»– crate ç”¨
- binary crate æ„å‘³ç€ç‹¬ç«‹è¿è¡Œ
- æ‰€ä»¥é€šå¸¸ binary crateï¼Œéƒ½ä¼šæŠŠé€»è¾‘æ”¾åœ¨ `lib.rs` é‡Œé¢ï¼Œæ–¹ä¾¿é›†æˆæµ‹è¯•ï¼Œ`main.rs` åªæœ‰å°‘é‡çš„è°ƒç”¨é€»è¾‘